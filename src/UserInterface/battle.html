<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãƒãƒ³ãƒãƒ­ãƒªãƒ³ - ãƒãƒˆãƒ«</title>
    <div id="my-id-disp" style="margin-top:6px; font-size:1.2rem; color:#8b4513;">ID:-</div>
    <style>
        @font-face { font-family: 'BananaSlip'; src: url('YDWbananaslipplus.otf') format('opentype'); }
        body {
            font-family: 'BananaSlip', sans-serif;
            background-color: #f7e7ce;
            margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 20px;
        }
        .dice-container { display: flex; gap: 15px; margin: 20px 0; min-height: 80px;}
        .dice { width: 60px; height: 60px; background: white; border: 2px solid #555; display: flex; justify-content: center; align-items: center; font-size: 2rem; border-radius: 8px;}

        .players-area { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; width: 100%; max-width: 1000px; }
        .player-card { border: 3px solid #8b4513; background: #fff; padding: 10px; width: 200px; border-radius: 10px; position: relative;}
        .player-card.is-me { border-color: #ff0000; box-shadow: 0 0 10px rgba(255,0,0,0.3); }
        .player-card.is-dealer { background-color: #fff8e1; }
        .player-card.is-turn { background-color: #e0f7fa; transform: scale(1.05); transition: 0.3s; }

        .dealer-badge { position: absolute; top: -10px; right: -10px; background: gold; border: 1px solid #000; padding: 2px 8px; font-size: 0.8rem; border-radius: 10px;}

        .info-row { display: flex; justify-content: space-between; margin-bottom: 5px; }

        .action-area { margin-top: 20px; padding: 20px; background: rgba(255,255,255,0.8); border-radius: 10px; text-align: center; min-height: 100px; display: flex; flex-direction: column; justify-content: center; align-items: center;}

        button { font-family: 'BananaSlip'; font-size: 1.2rem; padding: 10px 30px; cursor: pointer; background: #8b4513; color: white; border: none; border-radius: 5px;}
        button:disabled { background: #ccc; cursor: not-allowed; }

        .msg-box { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: 0.5s; pointer-events: none; z-index: 1001;}
        .msg-box.show { opacity: 1; top: 30px; }

        #debug-panel { position: fixed; bottom: 0; left: 0; background: #eee; padding: 5px; font-size: 0.8rem; opacity: 0.8; z-index: 900;}

        #cutin-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            opacity: 0;
            transition: opacity 0.3s;
        }
        #cutin-overlay.show { opacity: 1; }

        .cutin-content {
            display: flex;
            align-items: center;
            gap: 40px;
            transform: scale(0.8);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #cutin-overlay.show .cutin-content { transform: scale(1); }

        .monkey-img {
            width: 600px;
            height: 450px;
            border: 8px solid white;
            object-fit: cover;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.5);
        }

        .yaku-text-vertical {
            font-family: 'BananaSlip', sans-serif;
            font-size: 6rem;
            writing-mode: vertical-rl;
            text-orientation: upright;
            color: #ffcc00;
            text-shadow: 4px 4px 0px #8b4513;
            letter-spacing: 10px;
        }
    </style>
</head>
<body>

<div id="toast" class="msg-box"></div>

<div id="cutin-overlay">
    <div class="cutin-content">
        <div class="yaku-text-vertical" id="cutin-text-left">å½¹å</div>
        <img src="" id="monkey-photo" class="monkey-img" alt="æ¼”å‡ºç”»åƒ">
        <div class="yaku-text-vertical" id="cutin-text-right">å½¹å</div>
    </div>
</div>

<div style="text-align: center;">
    <h1 style="margin: 0; color: #8b4513;">ãƒãƒˆãƒ«ç”»é¢</h1>
    <div id="status-text">æ¥ç¶šå¾…æ©Ÿä¸­...</div>
</div>

<div class="dice-container" id="main-dice-area"></div>

<div class="action-area" id="action-panel">
    <div id="instruction-text">ã‚²ãƒ¼ãƒ é–‹å§‹ã‚’å¾…ã£ã¦ã„ã¾ã™...</div>
    <div style="margin-top: 10px;">
        <div id="bet-ui" style="display:none;">
            <input type="number" id="bet-input" value="100" style="font-size:1.2rem; width:80px;">
            <button onclick="sendBet()">è³­ã‘ã‚‹</button>
        </div>
        <button id="roll-btn" style="display:none;" onclick="sendRoll()">æ­¢ã‚ã‚‹</button>
    </div>
</div>

<div class="players-area" id="players-wrapper"></div>
<script>
    /*
    * ã‚„ã‚ŠãŸã„ã“ã¨(1/15)
    * å½¹ç¢ºå®š->ç”»åƒè¡¨ç¤ºã¾ã§ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚°è¨­å®š
    * ãƒ‡ãƒãƒƒã‚°ç”¨ãƒœã‚¿ãƒ³ã®é™¤å»
    * åŠ¹æœéŸ³è¨­å®š
    * */



    const GAME_SERVER_URL = "ws://localhost:8082/GameServer/ws";

    let ws = null;
    let myPlayerId = null;
    let lastPlayersData = [];//ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆä¿å­˜ç”¨ã«ã¤ã„ã‹ã—ãŸ

    // å½¹åã¨ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã²ã‚‚ã¥ã‘
    const yakuImages = {
        "ãƒ•ã‚¯ãƒ­ãƒ†ãƒŠã‚¬ã‚¶ãƒ«": "./fukurotenaga.jpg",
        "ãƒ†ãƒŠã‚¬ã‚¶ãƒ«": "./tenaga.jpg",
        "ãƒŠã‚¬ã‚¶ãƒ«": "./naga.jpg",
        "ã‚¯ãƒ­ã‚¶ãƒ«": "./kuro.jpg",
        "ãƒŠã‚¬ãƒ»ã‚¯ãƒ­ã‚¶ãƒ«": "./naga.jpg"
    };

    // å½¹ã«å¯¾å¿œã—ãŸåŠ¹æœéŸ³ã®è¨­å®š
    const yakuSounds = {
        "ãƒ•ã‚¯ãƒ­ãƒ†ãƒŠã‚¬ã‚¶ãƒ«": "./sounds/fukuro_cry.mp3", // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã¯é©å®œå¤‰æ›´ã—ã¦ãã ã•ã„
        "ãƒ†ãƒŠã‚¬ã‚¶ãƒ«": "./sounds/naga_cry.mp3",
        "ãƒŠã‚¬ã‚¶ãƒ«": "./sounds/naga_cry.mp3",
        "ã‚¯ãƒ­ã‚¶ãƒ«": "./sounds/kuro_cry.mp3",
        "ãƒŠã‚¬ãƒ»ã‚¯ãƒ­ã‚¶ãƒ«": ["./sounds/naga_cry.mp3", "./sounds/kuro_cry.mp3"]
    };



    // ===== å—ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç›´åˆ—å‡¦ç†ã™ã‚‹ã‚­ãƒ¥ãƒ¼ =====
    const messageQueue = [];
    let processing = false;

    const WAIT_AFTER_ROLL_MS = 300;  // ROLLè¡¨ç¤ºã®æœ€ä½æ™‚é–“
    const WAIT_HAND_MS = 1500;       // HANDè¡¨ç¤ºã®æœ€ä½æ™‚é–“ï¼ˆå½¹ã‚«ãƒƒãƒˆã‚¤ãƒ³ç­‰ã®ãŸã‚ï¼‰
    const WAIT_AFTER_RESULT_MS = 500;

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function enqueueMessage(msg) {
        messageQueue.push(msg);
        if (!processing) {
            processing = true;
            while (messageQueue.length > 0) {
                const next = messageQueue.shift();
                await handleMessageAsync(next);
            }
            processing = false;
        }
    }


    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰IDã‚’å–å¾— (?id=1 ãªã©)
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('id')) {
        myPlayerId = parseInt(urlParams.get('id'));
        document.getElementById('my-id-disp').innerText = myPlayerId;
    }

    // ===== ã‚µã‚¤ã‚³ãƒ­å›è»¢ï¼ˆç–‘ä¼¼ã‚¢ãƒ‹ãƒ¡ï¼‰åˆ¶å¾¡ =====
    let rollingTimer = null;
    const DICE_FACES = ["ãƒ•", "ã‚¯", "ãƒ­", "ãƒ†", "ãƒŠ", "ã‚¬"];

    function startRolling() {
        if (rollingTimer) return; // äºŒé‡èµ·å‹•é˜²æ­¢
        rollingTimer = setInterval(() => {
            const a = DICE_FACES[Math.floor(Math.random() * 6)];
            const b = DICE_FACES[Math.floor(Math.random() * 6)];
            const c = DICE_FACES[Math.floor(Math.random() * 6)];
            const d = DICE_FACES[Math.floor(Math.random() * 6)];
            const e = DICE_FACES[Math.floor(Math.random() * 6)];
            const f = DICE_FACES[Math.floor(Math.random() * 6)];
            renderDice(`${a}${b}${c}${d}${e}${f}`);
        }, 80);
    }


    function stopRolling(finalEyesStr) {
        if (rollingTimer) {
            clearInterval(rollingTimer);
            rollingTimer = null;
        }
        if (finalEyesStr) renderDice(finalEyesStr);
    }


    // ===== é€šä¿¡å‡¦ç† =====
    function connect() {
        ws = new WebSocket(GAME_SERVER_URL);

        ws.onopen = () => {
            log("ã‚µãƒ¼ãƒã«æ¥ç¶šã—ã¾ã—ãŸ");
            send({ phase: "START" });
        };

        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            enqueueMessage(msg);
        };

        ws.onclose = () => {
            log("åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ");
            document.getElementById("status-text").innerText = "åˆ‡æ–­";
            stopRolling();
            showRollUI(false);
        };
    }

    async function handleMessageAsync(msg) {
        console.log("Recv:", msg);

        if (msg.phase === "ERROR") {
            toast("ã‚¨ãƒ©ãƒ¼: " + msg.message);
            stopRolling();
            showRollUI(false);
            return;
        }

        if (msg.players) {
            lastPlayersData = msg.players;
            renderPlayers(msg.players);
        }

        switch (msg.phase) {
            case "START":
                if (myPlayerId === null && msg.playerId) {
                    myPlayerId = msg.playerId;
                    // my-id-disp ãŒç„¡ã„å ´åˆã§ã‚‚è½ã¡ãªã„ã‚ˆã†ã«
                    const el = document.getElementById("my-id-disp");
                    if (el) el.innerText = myPlayerId;
                    window.history.replaceState(null, null, "?id=" + myPlayerId);
                }
                updatePhaseDisplay("ã‚²ãƒ¼ãƒ é–‹å§‹ï¼");
                break;

            case "BET":
                stopRolling();
                showRollUI(false);

                // è‡ªåˆ†ã®çŠ¶æ…‹ã‚’æ¢ã™
                const me = lastPlayersData.find(p => p.playerId === myPlayerId);

                // è‡ªåˆ†ãŒè¦ª(dealer)ãªã‚‰UIã‚’å‡ºã•ãšã«å¾…æ©Ÿãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                if (me && me.dealer) {
                    updatePhaseDisplay("å­ãŒè³­ã‘ã‚‹ã®ã‚’å¾…ã£ã¦ã„ã¾ã™..."); // è¦ªç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    showBetUI(false); // UIã¯éš ã™
                } else {
                    updatePhaseDisplay("è³­ã‘ã‚¿ã‚¤ãƒ "); // å­ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    showBetUI(true);  // UIã‚’è¡¨ç¤º
                }
                break;

            case "ROLL":
                updatePhaseDisplay("ã‚µã‚¤ã‚³ãƒ­ã‚¿ã‚¤ãƒ : ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ " + msg.playerId + " ã®ç•ª");
                showBetUI(false);

                startRolling();                 // å…¨å“¡å›è»¢é–‹å§‹
                await sleep(WAIT_AFTER_ROLL_MS);// â˜…æœ€ä½è¡¨ç¤ºæ™‚é–“

                if (msg.playerId === myPlayerId) {
                    const btn = document.getElementById("roll-btn");
                    btn.textContent = "æ­¢ã‚ã‚‹";
                    showRollUI(true);
                    toast("ã‚ãªãŸã®ç•ªã§ã™ï¼ï¼ˆæ­¢ã‚ã‚‹ãƒœã‚¿ãƒ³ã§ç¢ºå®šï¼‰");
                } else {
                    showRollUI(false);
                }
                break;

            case "HAND":
                stopRolling();
                showRollUI(false); // ä¸€æ—¦ãƒœã‚¿ãƒ³ã‚’éš ã™

                renderDice(msg.eyesRolled);

                // 2ç§’ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚°ï¼ˆæ¼”å‡ºç”¨ï¼‰
                await sleep(2000);

                if (msg.hand && msg.hand.handStrength > 0) {
                    // --- å½¹ãŒã‚ã£ãŸå ´åˆ ---
                    toast(`Player ${msg.playerId} ã®å‡ºç›®: ${msg.eyesRolled} â†’ å½¹: ${msg.hand.handName}ï¼`);
                    await showCutInAsync(msg.hand.handName, 2600);
                } else {
                    // --- å½¹ãŒå‡ºãªã‹ã£ãŸå ´åˆï¼ˆã‚„ã‚Šç›´ã—ï¼‰ ---
                    toast(`Player ${msg.playerId} ã¯å½¹ãªã—... (ã‚„ã‚Šç›´ã— ${msg.rerollCount}å›ç›®)`);

                    // è‡ªåˆ†ã®ç•ªã§ã‚ã‚Œã°ã€å†ã³ã€Œæ­¢ã‚ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ã¦å…¥åŠ›ã‚’å¾…ã¤
                    if (msg.playerId === myPlayerId) {
                        const btn = document.getElementById("roll-btn");
                        btn.textContent = "æ­¢ã‚ã‚‹"; // ã¾ãŸã¯ã€Œã‚‚ã†ä¸€åº¦æŒ¯ã‚‹ã€
                        showRollUI(true);
                        startRolling(); // å†ã³ã‚µã‚¤ã‚³ãƒ­ã‚’å›è»¢ã•ã›ã‚‹
                        toast("å½¹ãŒå‡ºã¾ã›ã‚“ã§ã—ãŸã€‚è‡ªå‹•ã§æŒ¯ã‚ŠãªãŠã—ã¾ã™ã€‚");
                    }

                    await sleep(WAIT_HAND_MS);
                }
                break;


            case "RESULT":
                stopRolling();
                showRollUI(false);

                toast(msg.message);
                updatePhaseDisplay("çµæœç™ºè¡¨: " + msg.message);

                try {
                    localStorage.setItem("chinchi_last_result", JSON.stringify(msg));
                } catch (e) {}

                await sleep(WAIT_AFTER_RESULT_MS);

                location.href = "./result.html";
                break;

            case "STATE":
                // ã™ã§ã« renderPlayers ã—ã¦ã„ã‚‹ã®ã§ã“ã“ã¯ä½•ã‚‚ã—ãªãã¦OK
                break;
        }
    }


    // ===== é€ä¿¡ =====
    function sendBet() {
        const amount = parseInt(document.getElementById("bet-input").value);
        if (!amount || amount <= 0) return;

        send({
            phase: "BET",
            betBananas: amount
        });
        showBetUI(false);
    }

    function sendRoll() {
        // â˜…ã€Œæ­¢ã‚ã‚‹ã€ï¼ ROLL ã‚’é€ã‚‹ï¼ˆä»•æ§˜ã©ãŠã‚Šï¼‰
        send({ phase: "ROLL" });

        // é€£æ‰“é˜²æ­¢ï¼ˆHANDãŒæ¥ãŸã‚‰éè¡¨ç¤ºã«ãªã‚‹ï¼‰
        const btn = document.getElementById("roll-btn");
        btn.disabled = true;
    }

    function send(obj) {
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify(obj));
        } else {
            toast("ã‚µãƒ¼ãƒã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“");
        }
    }

    // ===== UI =====
    function preloadYakuImages() {
        Object.values(yakuImages).forEach(src => {
            const im = new Image();
            im.src = src;
        });
    }
    preloadYakuImages();

    /**
     * ã‚«ãƒƒãƒˆã‚¤ãƒ³ã‚’è¡¨ç¤ºã—ã€è¡¨ç¤ºå®Œäº†å¾Œã« resolve ã™ã‚‹ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼ã¨åŒæœŸã•ã›ã‚‹ï¼‰
     */
    function showCutInAsync(handName, durationMs = 2600) {
        return new Promise((resolve) => {
            const overlay = document.getElementById('cutin-overlay');
            const img = document.getElementById('monkey-photo');
            const leftText = document.getElementById('cutin-text-left');
            const rightText = document.getElementById('cutin-text-right');

            leftText.innerText = handName;
            rightText.innerText = handName;

            const imgSrc = yakuImages[handName];
            ///////////////////////////////////////////////
            //éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®å·®ã—è¾¼ã¿
            ///////////////////////////////////////////////
            const soundSrc = yakuSounds[handName];

            const startShow = () => {
                if (soundSrc) {
                    //éŸ³å£°å†ç”Ÿ/////////////////////////////////////
                    const audio = new Audio(soundSrc);
                    audio.volume = 0.5; // éŸ³é‡ï¼ˆ0.0ã€œ1.0ï¼‰
                    audio.play().catch(e => console.error("éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:", e));
                }//ã“ã“ã¾ã§éŸ³å£°å†ç”Ÿ//////////////////////////////////////////////
                overlay.style.display = "flex";
                requestAnimationFrame(() => overlay.classList.add("show"));

                setTimeout(() => {
                    overlay.classList.remove("show");
                    setTimeout(() => {
                        overlay.style.display = "none";
                        resolve();
                    }, 300);
                }, durationMs);
            };

            if (imgSrc) {
                img.style.display = "block";

                // èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«è¦‹ã›ã‚‹ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿ã§ã‚‚ onload ã¯ç™ºç«ã™ã‚‹ï¼‰
                img.onload = startShow;
                img.onerror = () => {
                    // ç”»åƒãŒèª­ã‚ãªãã¦ã‚‚ãƒ†ã‚­ã‚¹ãƒˆæ¼”å‡ºã ã‘ã¯å‡ºã™
                    img.style.display = "none";
                    startShow();
                };

                img.src = imgSrc;
            } else {
                // å¯¾å¿œç”»åƒãŒãªã„å½¹åãªã‚‰ç”»åƒã¯å‡ºã•ãšã«ãƒ†ã‚­ã‚¹ãƒˆæ¼”å‡ºã®ã¿
                img.style.display = "none";
                startShow();
            }
        });
    }



    function renderPlayers(players) {
        const wrapper = document.getElementById("players-wrapper");
        wrapper.innerHTML = "";

        players.forEach(p => {
            const isMe = (p.playerId === myPlayerId);
            const div = document.createElement("div");
            div.className = "player-card" + (isMe ? " is-me" : "") + (p.dealer ? " is-dealer" : "");

            div.innerHTML = `
                ${p.dealer ? '<div class="dealer-badge">ãƒœã‚¹çŒ¿</div>' : ''}
                <div class="info-row">
                    <strong>${p.name}</strong>
                    <span>ID:${p.playerId}</span>
                </div>
                <div class="info-row">
                    <span>æ‰€æŒ: ${p.ownedBananas}ğŸŒ</span>
                </div>
                <div class="info-row" style="background:#eee; padding:2px;">
    <span>è³­ã‘: ${(
                (p.currentBetBananas ?? p.betBananas ?? 0)
            )}ğŸŒ</span>
</div>

            `;
            wrapper.appendChild(div);
        });
    }

    function renderDice(eyesStr) {
        const container = document.getElementById("main-dice-area");
        container.innerHTML = "";
        if (!eyesStr) return;

        for (let char of eyesStr) {
            const d = document.createElement("div");
            d.className = "dice";
            d.innerText = char;
            container.appendChild(d);
        }
    }

    function showBetUI(show) {
        document.getElementById("bet-ui").style.display = show ? "block" : "none";
        document.getElementById("roll-btn").style.display = "none";
    }

    // â˜…ã€Œæ­¢ã‚ã‚‹ã€ãƒœã‚¿ãƒ³è¡¨ç¤ºï¼ˆROLLã® playerId ãŒè‡ªåˆ†ã®ã¨ãã ã‘ä½¿ã†ï¼‰
    function showRollUI(show) {
        const btn = document.getElementById("roll-btn");
        // ãƒ†ã‚­ã‚¹ãƒˆã¯å‘¼ã³å‡ºã—å…ƒã§åˆ¶å¾¡ã§ãã‚‹ã‚ˆã†ã«ã€ã“ã“ã§ã¯å¼·åˆ¶å¤‰æ›´ã—ãªã„
        btn.style.display = show ? "inline-block" : "none";
        btn.disabled = false; // â˜… showã®æ™‚ã«å¿…ãšæŠ¼ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹
        document.getElementById("bet-ui").style.display = "none";
    }

    function updatePhaseDisplay(text) {
        document.getElementById("instruction-text").innerText = text;
    }

    function toast(msg) {
        const el = document.getElementById("toast");
        el.innerText = msg;
        el.classList.add("show");
        setTimeout(() => el.classList.remove("show"), 3000);
    }

    function log(txt) {
        console.log("[Client]", txt);
    }

    window.forceBind = function(id) {
        myPlayerId = id;
        document.getElementById('my-id-disp').innerText = id;
        send({ phase: "START" });
    }

    connect();
</script>
</body>
</html>
