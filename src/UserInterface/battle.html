<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãƒãƒ³ãƒãƒ­ãƒªãƒ³ - ãƒãƒˆãƒ«</title>
    <style>
        @font-face { font-family: 'BananaSlip'; src: url('YDWbananaslipplus.otf') format('opentype'); }
        body {
            font-family: 'BananaSlip', sans-serif;
            background-color: #f7e7ce;
            margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 20px;
        }
        /* UIãƒ‘ãƒ¼ãƒ„ã®ã‚¹ã‚¿ã‚¤ãƒ« (å…±é€š) */
        .dice-container { display: flex; gap: 15px; margin: 20px 0; min-height: 80px;}
        .dice { width: 60px; height: 60px; background: white; border: 2px solid #555; display: flex; justify-content: center; align-items: center; font-size: 2rem; border-radius: 8px;}

        .players-area { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; width: 100%; max-width: 1000px; }
        .player-card { border: 3px solid #8b4513; background: #fff; padding: 10px; width: 200px; border-radius: 10px; position: relative;}
        .player-card.is-me { border-color: #ff0000; box-shadow: 0 0 10px rgba(255,0,0,0.3); }
        .player-card.is-dealer { background-color: #fff8e1; }
        .player-card.is-turn { background-color: #e0f7fa; transform: scale(1.05); transition: 0.3s; }

        .dealer-badge { position: absolute; top: -10px; right: -10px; background: gold; border: 1px solid #000; padding: 2px 8px; font-size: 0.8rem; border-radius: 10px;}

        .info-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .hand-name { font-weight: bold; color: #d35b31; font-size: 1.2rem; text-align: center; margin: 5px 0;}

        .action-area { margin-top: 20px; padding: 20px; background: rgba(255,255,255,0.8); border-radius: 10px; text-align: center; min-height: 100px; display: flex; flex-direction: column; justify-content: center; align-items: center;}

        button { font-family: 'BananaSlip'; font-size: 1.2rem; padding: 10px 30px; cursor: pointer; background: #8b4513; color: white; border: none; border-radius: 5px;}
        button:disabled { background: #ccc; cursor: not-allowed; }

        .msg-box { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: 0.5s; pointer-events: none; z-index: 1001;}
        .msg-box.show { opacity: 1; top: 30px; }

        /* ãƒ‡ãƒãƒƒã‚°ç”¨ */
        #debug-panel { position: fixed; bottom: 0; left: 0; background: #eee; padding: 5px; font-size: 0.8rem; opacity: 0.8; z-index: 900;}

        /* ========== è¿½åŠ : ã‚«ãƒƒãƒˆã‚¤ãƒ³æ¼”å‡ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« ========== */
        #cutin-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.85);
            display: none; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéè¡¨ç¤º */
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            opacity: 0;
            transition: opacity 0.3s;
        }
        #cutin-overlay.show {
            opacity: 1;
        }

        .cutin-content {
            display: flex;
            align-items: center;
            gap: 40px;
            transform: scale(0.8);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #cutin-overlay.show .cutin-content {
            transform: scale(1);
        }

        /* ç”»åƒã‚¹ã‚¿ã‚¤ãƒ« */
        .monkey-img {
            width: 600px;  /* ç”»é¢ã«åˆã‚ã›ã¦èª¿æ•´ */
            height: 450px;
            border: 8px solid white;
            object-fit: cover;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.5);
        }

        /* ç¸¦æ›¸ããƒ†ã‚­ã‚¹ãƒˆ */
        .yaku-text-vertical {
            font-family: 'BananaSlip', sans-serif;
            font-size: 6rem;
            writing-mode: vertical-rl;
            text-orientation: upright;
            color: #ffcc00;
            text-shadow: 4px 4px 0px #8b4513;
            letter-spacing: 10px;
        }
    </style>
</head>
<body>

<div id="toast" class="msg-box"></div>

<div id="cutin-overlay">
    <div class="cutin-content">
        <div class="yaku-text-vertical" id="cutin-text-left">å½¹å</div>
        <img src="" id="monkey-photo" class="monkey-img" alt="æ¼”å‡ºç”»åƒ">
        <div class="yaku-text-vertical" id="cutin-text-right">å½¹å</div>
    </div>
</div>

<div style="text-align: center;">
    <h1 style="margin: 0; color: #8b4513;">ãƒãƒˆãƒ«ç”»é¢</h1>
    <div id="status-text">æ¥ç¶šå¾…æ©Ÿä¸­...</div>
</div>

<div class="dice-container" id="main-dice-area">
</div>

<div class="action-area" id="action-panel">
    <div id="instruction-text">ã‚²ãƒ¼ãƒ é–‹å§‹ã‚’å¾…ã£ã¦ã„ã¾ã™...</div>
    <div style="margin-top: 10px;">
        <div id="bet-ui" style="display:none;">
            <input type="number" id="bet-input" value="100" style="font-size:1.2rem; width:80px;">
            <button onclick="sendBet()">è³­ã‘ã‚‹</button>
        </div>
        <button id="roll-btn" style="display:none;" onclick="sendRoll()">ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹</button>
    </div>
</div>

<div class="players-area" id="players-wrapper"></div>

<div id="debug-panel">
    My Player ID: <span id="my-id-disp">-</span>
    <button onclick="forceBind(1)">ID=1ã¨ã—ã¦å‚åŠ </button>
    <button onclick="forceBind(2)">ID=2ã¨ã—ã¦å‚åŠ </button>
    <button onclick="forceBind(3)">ID=3ã¨ã—ã¦å‚åŠ </button>
    <button onclick="forceBind(4)">ID=4ã¨ã—ã¦å‚åŠ </button>
</div>

<script>

    //ã‚„ã‚‹ã“ã¨(1/14)
    //æœ€åˆã®ã‚¿ãƒ¼ãƒ³ã§ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ›ã‘é‡‘ã‚’è¨­å®šã§ãã¦ã„ãªã„
    //çµæœç™ºè¡¨ç”»é¢




    //  ã‚²ãƒ¼ãƒ ã‚µãƒ¼ãƒã®ãƒãƒ¼ãƒˆã¯ 8082 (WebSocketç”¨ã€83ã¯REST)
    const GAME_SERVER_URL = "ws://10.17.147.5:8082/GameServer/ws";

    let ws = null;
    let myPlayerId = null; // è‡ªåˆ†ã®ID (1ï½4)

    // å½¹åã¨ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã²ã‚‚ã¥ã‘///////////////////////////////
    const yakuImages = {
        "ãƒ•ã‚¯ãƒ­ãƒ†ãƒŠã‚¬ã‚¶ãƒ«": "fukurotenaga.jpg",
        "ãƒ†ãƒŠã‚¬ã‚¶ãƒ«": "tenaga.jpg",
        "ãƒŠã‚¬ã‚¶ãƒ«": "naga.jpg",
        "ã‚¯ãƒ­ã‚¶ãƒ«": "kuro.jpg",
        "ãƒŠã‚¬ãƒ»ã‚¯ãƒ­ã‚¶ãƒ«": "naga.jpg" // ã ã‚Œã‹ãŒã‚¯ãƒ­ã‚¶ãƒ«ã¨ãƒŠã‚¬ã‚¶ãƒ«ã®ãƒ„ãƒ¼ã‚·ãƒ§ãƒƒãƒˆã‚’ç™»éŒ²
    };

    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰IDã‚’å–å¾— (?id=1 ãªã©)
    const urlParams = new URLSearchParams(window.location.search);
    if(urlParams.has('id')) {
        myPlayerId = parseInt(urlParams.get('id'));
        document.getElementById('my-id-disp').innerText = myPlayerId;
    }

    // ========== é€šä¿¡å‡¦ç† ==========

    function connect() {
        ws = new WebSocket(GAME_SERVER_URL);

        ws.onopen = () => {
            log("ã‚µãƒ¼ãƒã«æ¥ç¶šã—ã¾ã—ãŸ");
            send({ phase: "START" });
        };

        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            handleMessage(msg);
        };

        ws.onclose = () => {
            log("åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ");
            document.getElementById("status-text").innerText = "åˆ‡æ–­";
        };
    }

    function handleMessage(msg) {
        console.log("Recv:", msg);

        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        if (msg.phase === "ERROR") {
            toast("ã‚¨ãƒ©ãƒ¼: " + msg.message);
            return;
        }

        // å…±é€š: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çŠ¶æ…‹ã®æ›´æ–°
        if (msg.players) {
            renderPlayers(msg.players);
        }

        switch (msg.phase) {
            case "START":
                if (myPlayerId === null && msg.playerId) {
                    myPlayerId = msg.playerId;
                    document.getElementById('my-id-disp').innerText = myPlayerId;
                    toast("ã‚²ãƒ¼ãƒ ã«å‚åŠ ã—ã¾ã—ãŸ (ID: " + myPlayerId + ")");
                    window.history.replaceState(null, null, "?id=" + myPlayerId);
                }
                document.getElementById("instruction-text").innerText = "ã‚²ãƒ¼ãƒ é–‹å§‹ï¼";
                break;

            case "BET":
                updatePhaseDisplay("è³­ã‘ã‚¿ã‚¤ãƒ ");
                showBetUI(true);
                break;

            case "ROLL":
                updatePhaseDisplay("ã‚µã‚¤ã‚³ãƒ­ã‚¿ã‚¤ãƒ : ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ " + msg.playerId + " ã®ç•ª");
                showBetUI(false);

                if (msg.playerId === myPlayerId) {
                    showRollUI(true);
                    toast("ã‚ãªãŸã®ç•ªã§ã™ï¼");
                } else {
                    showRollUI(false);
                }
                break;

            case "HAND":
                // èª°ã‹ãŒã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã£ãŸçµæœ
                const pName = "Player " + msg.playerId;
                renderDice(msg.eyesRolled); // ä¸­å¤®ã«ã‚µã‚¤ã‚³ãƒ­è¡¨ç¤º

                let info = pName + " ã®å‡ºç›®: " + msg.eyesRolled;

                // ========== ä¿®æ­£: å½¹æˆç«‹æ™‚ã®å‡¦ç† ==========
                if (msg.hand && msg.hand.handStrength > 0) {
                    info += " â†’ å½¹: " + msg.hand.handName + "ï¼";
                    toast(info);

                    // â˜…ã‚«ãƒƒãƒˆã‚¤ãƒ³è¡¨ç¤º
                    showCutIn(msg.hand.handName);

                } else {
                    info += " (ã‚„ã‚Šç›´ã— " + msg.rerollCount + "å›ç›®)";
                }

                if (msg.playerId === myPlayerId && !msg.isFinal) {
                    showRollUI(true);
                } else {
                    showRollUI(false);
                }
                break;

            case "RESULT":
                toast(msg.message); // GAME_END ãªã©
                updatePhaseDisplay("çµæœç™ºè¡¨: " + msg.message);
                break;

            case "STATE":
                break;
        }
    }

    // ========== é€ä¿¡ ==========

    function sendBet() {
        const amount = parseInt(document.getElementById("bet-input").value);
        if (!amount || amount <= 0) return;

        send({
            phase: "BET",
            betBananas: amount
        });
        showBetUI(false);
    }

    function sendRoll() {
        send({ phase: "ROLL" });
        document.getElementById("roll-btn").disabled = true;
    }

    function send(obj) {
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify(obj));
        } else {
            toast("ã‚µãƒ¼ãƒã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“");
        }
    }

    // ========== UI æç”»é–¢é€£ ==========

    // ========== è¿½åŠ : ã‚«ãƒƒãƒˆã‚¤ãƒ³è¡¨ç¤ºé–¢æ•° ==========
    function showCutIn(handName) {
        const overlay = document.getElementById('cutin-overlay');
        const img = document.getElementById('monkey-photo');
        const leftText = document.getElementById('cutin-text-left');
        const rightText = document.getElementById('cutin-text-right');

        // ãƒ†ã‚­ã‚¹ãƒˆè¨­å®š
        leftText.innerText = handName;
        rightText.innerText = handName;

        // ç”»åƒè¨­å®š (ãƒãƒƒãƒ”ãƒ³ã‚°ã«ãªã„å ´åˆã¯ç”»åƒéè¡¨ç¤º)
        const imgSrc = yakuImages[handName];
        if (imgSrc) {
            img.src = imgSrc;
            img.style.display = "block";
        } else {
            img.style.display = "none";
        }

        // è¡¨ç¤ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        overlay.style.display = "flex";
        requestAnimationFrame(() => {
            overlay.classList.add("show");
        });

        // 3ç§’å¾Œã«æ¶ˆã™
        setTimeout(() => {
            overlay.classList.remove("show");
            setTimeout(() => {
                overlay.style.display = "none";
            }, 300); // transitionæ™‚é–“å¾…ã¡
        }, 3000);
    }

    function renderPlayers(players) {
        const wrapper = document.getElementById("players-wrapper");
        wrapper.innerHTML = "";

        players.forEach(p => {
            const isMe = (p.playerId === myPlayerId);
            const div = document.createElement("div");
            div.className = "player-card" + (isMe ? " is-me" : "") + (p.dealer ? " is-dealer" : "");

            div.innerHTML = `
                ${p.dealer ? '<div class="dealer-badge">è¦ª</div>' : ''}
                <div class="info-row">
                    <strong>${p.name}</strong>
                    <span>ID:${p.playerId}</span>
                </div>
                <div class="info-row">
                    <span>æ‰€æŒ: ${p.ownedBananas}ğŸŒ</span>
                </div>
                <div class="info-row" style="background:#eee; padding:2px;">
                    <span>è³­ã‘: ${p.betBananas}</span>
                </div>
                `;
            wrapper.appendChild(div);
        });
    }

    function renderDice(eyesStr) {
        const container = document.getElementById("main-dice-area");
        container.innerHTML = "";
        if (!eyesStr) return;

        for (let char of eyesStr) {
            const d = document.createElement("div");
            d.className = "dice";
            d.innerText = char;
            container.appendChild(d);
        }
    }

    function showBetUI(show) {
        document.getElementById("bet-ui").style.display = show ? "block" : "none";
        document.getElementById("roll-btn").style.display = "none";
    }

    function showRollUI(show) {
        const btn = document.getElementById("roll-btn");
        btn.style.display = show ? "inline-block" : "none";
        btn.disabled = !show;
        document.getElementById("bet-ui").style.display = "none";
    }

    function updatePhaseDisplay(text) {
        document.getElementById("instruction-text").innerText = text;
    }

    function toast(msg) {
        const el = document.getElementById("toast");
        el.innerText = msg;
        el.classList.add("show");
        setTimeout(() => el.classList.remove("show"), 3000);
    }

    function log(txt) {
        console.log("[Client]", txt);
    }

    window.forceBind = function(id) {
        myPlayerId = id;
        document.getElementById('my-id-disp').innerText = id;
        send({ phase: "START" });
    }

    connect();

    function getMyPlayerState(players) {
        if(!players) return null;
        return players.find(p => p.playerId === myPlayerId);
    }

</script>
</body>
</html>