<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãƒãƒ³ãƒãƒ­ãƒªãƒ³ - ãƒãƒˆãƒ«</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Yuji+Syuku&display=swap" rel="stylesheet">
    <div id="my-id-disp" style="margin-top:6px; font-size:1.2rem; color:#8b4513;">ID:-</div>
    <style>
        @font-face { font-family: 'BananaSlip'; src: url('YDWbananaslipplus.otf') format('opentype'); }
        body {
            font-family: 'BananaSlip', sans-serif;
            background-color: #f7e7ce;
            margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 20px;
        }
        .dice-container { display: flex; gap: 15px; margin: 20px 0; min-height: 80px;}
        .dice { width: 60px; height: 60px; background: white; border: 2px solid #555; display: flex; justify-content: center; align-items: center; font-size: 2rem; border-radius: 8px;}

        .players-area { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; width: 100%; max-width: 1000px; }
        .player-card { border: 3px solid #8b4513; background: #fff; padding: 10px; width: 200px; border-radius: 10px; position: relative;}
        .player-card.is-me { border-color: #ff0000; box-shadow: 0 0 10px rgba(255,0,0,0.3); }
        .player-card.is-dealer { background-color: #fff8e1; }
        .player-card.is-turn { background-color: #e0f7fa; transform: scale(1.05); transition: 0.3s; }

        .dealer-badge {
            position: absolute;
            top: -15px;
            right: -10px;
            background: gold;
            border: 2px solid #000;
            padding: 4px 12px;

            /* â˜…ã“ã“ãŒãƒã‚¤ãƒ³ãƒˆ: èª­ã¿è¾¼ã‚“ã é”ç­†ãƒ•ã‚©ãƒ³ãƒˆã‚’æŒ‡å®š */
            font-family: 'Yuji Syuku', serif;
            font-size: 1.3rem;

            border-radius: 8px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
            z-index: 10;
        }

        .info-row { display: flex; justify-content: space-between; margin-bottom: 5px; }

        .action-area { margin-top: 20px; padding: 20px; background: rgba(255,255,255,0.8); border-radius: 10px; text-align: center; min-height: 100px; display: flex; flex-direction: column; justify-content: center; align-items: center;}

        button { font-family: 'BananaSlip'; font-size: 1.2rem; padding: 10px 30px; cursor: pointer; background: #8b4513; color: white; border: none; border-radius: 5px;}
        button:disabled { background: #ccc; cursor: not-allowed; }

        .msg-box { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: 0.5s; pointer-events: none; z-index: 1001;}
        .msg-box.show { opacity: 1; top: 30px; }

        #debug-panel { position: fixed; bottom: 0; left: 0; background: #eee; padding: 5px; font-size: 0.8rem; opacity: 0.8; z-index: 900;}

        #cutin-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            opacity: 0;
            transition: opacity 1s ease;
        }
        #cutin-overlay.show { opacity: 1; }

        .cutin-content {
            /* ãƒ•ãƒ¬ãƒƒã‚¯ã‚¹ãƒœãƒƒã‚¯ã‚¹(æ¨ªä¸¦ã³)ã‚’ã‚„ã‚ã€ç”»é¢å…¨ä½“ã‚’ä½¿ã†è¨­å®šã«å¤‰æ›´ */
            position: relative;
            width: 100%;
            height: 100%;

            /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ */
            transform: scale(0.8);
            transition: transform 1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        /*#cutin-overlay.show .cutin-content { transform: scale(1); }*/

        .monkey-img {
            /* ç”»é¢ã„ã£ã±ã„ã«è¡¨ç¤º */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;

            /* ç”»åƒã®ç¸¦æ¨ªæ¯”ã‚’ä¿ã£ãŸã¾ã¾ç”»é¢ã«åã‚ã‚‹ãªã‚‰ 'contain' */
            /* ç”»é¢å…¨ä½“ã‚’éš™é–“ãªãåŸ‹ã‚ã‚‹ãªã‚‰ 'cover' (ä¸Šä¸‹å·¦å³ãŒåˆ‡ã‚Œã‚‹å ´åˆã‚ã‚Š) */
            object-fit: contain;

            /* æ ç·šãªã©ã‚’å‰Šé™¤ */
            border: none;
            box-shadow: none;
            z-index: 1; /* æ–‡å­—ã‚ˆã‚Šå¥¥ã« */
        }

        /* ä¿®æ­£å‰: font-family: 'BananaSlip', sans-serif; */

        .yaku-text-vertical {
            font-family: 'Yuji Syuku', serif; /* å‰å›ã®ãƒ•ã‚©ãƒ³ãƒˆè¨­å®šã‚’ç¶­æŒ */
            font-size: 6rem;
            writing-mode: vertical-rl;
            text-orientation: upright;
            color: #ffcc00;
            text-shadow: 4px 4px 0px #8b4513, -2px -2px 0px #000; /* æ–‡å­—ãŒè¦‹ã‚„ã™ã„ã‚ˆã†ã«å½±ã‚’å¼·åŒ– */
            letter-spacing: 10px;

            /* ç”»åƒã®ä¸Šã«é…ç½®ã™ã‚‹ãŸã‚ã®çµ¶å¯¾é…ç½® */
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 2; /* ç”»åƒã‚ˆã‚Šæ‰‹å‰ã« */
        }

        #cutin-text-left {
            left: 5%;
        }

        #cutin-text-right {
            right: 5%;
        }


        /* ãƒ©ã‚¦ãƒ³ãƒ‰çµæœãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
        #round-result-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.5s;
        }
        #round-result-overlay.show { opacity: 1; }

        .round-result-box {
            background: #fff; border: 5px solid #8b4513; border-radius: 20px;
            padding: 30px; width: 500px; text-align: center;
            box-shadow: 0 0 30px rgba(255, 204, 0, 0.5);
        }
        .round-winner-title {
            font-size: 2.5rem; color: #d35b31; margin: 0 0 20px 0;
            text-shadow: 2px 2px 0px #fff;
        }
        .round-result-list {
            margin-bottom: 20px; border-top: 2px dashed #ccc; border-bottom: 2px dashed #ccc;
            padding: 10px 0;
        }
        .round-result-item {
            display: flex; justify-content: space-between; font-size: 1.5rem; margin: 8px 0;
        }
        .diff-plus { color: #e91e63; font-weight: bold; }
        .diff-minus { color: #3f51b5; }
        .diff-zero { color: #777; }
        .next-dealer-info {
            font-size: 1.2rem; color: #8b4513; font-weight: bold; background: #fff8e1;
            padding: 10px; border-radius: 10px; display: inline-block;
        }
    </style>
</head>
<body>

<div id="toast" class="msg-box"></div>

<div id="cutin-overlay">
    <div class="cutin-content">
        <div class="yaku-text-vertical" id="cutin-text-left">å½¹å</div>
        <img src="" id="monkey-photo" class="monkey-img" alt="æ¼”å‡ºç”»åƒ">
        <div class="yaku-text-vertical" id="cutin-text-right">å½¹å</div>
    </div>
</div>

<div id="round-result-overlay" style="display:none;">
    <div class="round-result-box">
        <h2 class="round-winner-title" id="round-winner-text">èª°ã‚‚å‹ã¦ã¾ã›ã‚“ã§ã—ãŸ...</h2>
        <div id="round-result-list" class="round-result-list">
        </div>
        <div class="next-dealer-info" id="next-dealer-text">æ¬¡ã¯ ã€‡ã€‡ ãŒè¦ªã§ã™</div>
    </div>
</div>

<div style="text-align: center;">
    <h1 style="margin: 0; color: #8b4513;">ãƒãƒˆãƒ«ç”»é¢</h1>
    <div id="status-text">æ¥ç¶šå¾…æ©Ÿä¸­...</div>
</div>

<div class="dice-container" id="main-dice-area"></div>

<div class="action-area" id="action-panel">
    <div id="instruction-text">ã‚²ãƒ¼ãƒ é–‹å§‹ã‚’å¾…ã£ã¦ã„ã¾ã™...</div>
    <div style="margin-top: 10px;">
        <div id="bet-ui" style="display:none;">
            <input type="number" id="bet-input" value="100" style="font-size:1.2rem; width:80px;">
            <button onclick="sendBet()">è³­ã‘ã‚‹</button>
        </div>
        <button id="roll-btn" style="display:none;" onclick="sendRoll()">æ­¢ã‚ã‚‹</button>
    </div>
</div>

<div class="players-area" id="players-wrapper"></div>
<script>
    /*
    * ã‚„ã‚ŠãŸã„ã“ã¨(1/15)
    * å½¹ç¢ºå®š->ç”»åƒè¡¨ç¤ºã¾ã§ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚°è¨­å®š
    * ãƒ‡ãƒãƒƒã‚°ç”¨ãƒœã‚¿ãƒ³ã®é™¤å»
    * åŠ¹æœéŸ³è¨­å®š
    * */



    //const GAME_SERVER_URL = "ws://localhost:8082/GameServer/ws";
    const GAME_SERVER_URL = "ws://10.17.147.78:8082/GameServer/ws";

    let ws = null;
    let myPlayerId = null;
    let lastPlayersData = [];//ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆä¿å­˜ç”¨ã«ã¤ã„ã‹ã—ãŸ

    // å½¹åã¨ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã²ã‚‚ã¥ã‘
    const yakuImages = {
        "ãƒ•ã‚¯ãƒ­ãƒ†ãƒŠã‚¬ã‚¶ãƒ«": "./fukurotenaga.jpg",
        "ãƒ†ãƒŠã‚¬ã‚¶ãƒ«": "./tenaga.jpg",
        "ãƒŠã‚¬ã‚¶ãƒ«": "./naga.jpg",
        "ã‚¯ãƒ­ã‚¶ãƒ«": "./kuro.jpg",
        "ãƒŠã‚¬ãƒ»ã‚¯ãƒ­ã‚¶ãƒ«": "./naga.jpg"
    };

    // å½¹ã«å¯¾å¿œã—ãŸåŠ¹æœéŸ³ã®è¨­å®š
    const yakuSounds = {
        "ãƒ•ã‚¯ãƒ­ãƒ†ãƒŠã‚¬ã‚¶ãƒ«": "./sounds/fukuro_cry.mp3", // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã¯é©å®œå¤‰æ›´ã—ã¦ãã ã•ã„
        "ãƒ†ãƒŠã‚¬ã‚¶ãƒ«": "./sounds/naga_cry.mp3",
        "ãƒŠã‚¬ã‚¶ãƒ«": "./sounds/naga_cry.mp3",
        "ã‚¯ãƒ­ã‚¶ãƒ«": "./sounds/kuro_cry.mp3",
        "ãƒŠã‚¬ãƒ»ã‚¯ãƒ­ã‚¶ãƒ«": ["./sounds/naga_cry.mp3", "./sounds/kuro_cry.mp3"]
    };
    ////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////
    /////////////æ³¨æ„ï¼ã€€éŸ³é‡ã¯0.0 ~ 1.0ã€€ã«åã‚ã‚‹ï¼ˆï¼‘æ•—ï¼‰//////////////
    //////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////
    const stopSound = new Audio("./sounds/dice_stop.mp3");//ã‚µã‚¤ã‚³ãƒ­SE
    stopSound.volume = 1.0;

    const betSound = new Audio("./sounds/monkey_cry.mp3");//è³­ã‘ã‚‹ã¨ãã®SE
    betSound.volume = 1.0;

    const roundSound = new Audio("./sounds/round_change.mp3");
    roundSound.volume = 0.5;

    const battleBgm = new Audio("./sounds/battle_bgm.mp3");
    battleBgm.loop = true;   // ãƒ«ãƒ¼ãƒ—å†ç”Ÿ
    battleBgm.volume = 0.08;



    // ===== å—ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç›´åˆ—å‡¦ç†ã™ã‚‹ã‚­ãƒ¥ãƒ¼ =====
    const messageQueue = [];
    let processing = false;

    const WAIT_AFTER_ROLL_MS = 300;  // ROLLè¡¨ç¤ºã®æœ€ä½æ™‚é–“
    const WAIT_HAND_MS = 1500;       // HANDè¡¨ç¤ºã®æœ€ä½æ™‚é–“ï¼ˆå½¹ã‚«ãƒƒãƒˆã‚¤ãƒ³ç­‰ã®ãŸã‚ï¼‰
    const WAIT_AFTER_RESULT_MS = 2000;
    const WAIT_ROUND_RESULT_MS = 4000;//ãƒ©ã‚¦ãƒ³ãƒ‰çµæœã®è¡¨ç¤ºæ™‚é–“

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function enqueueMessage(msg) {
        messageQueue.push(msg);
        if (!processing) {
            processing = true;
            while (messageQueue.length > 0) {
                const next = messageQueue.shift();
                await handleMessageAsync(next);
            }
            processing = false;
        }
    }


    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰IDã‚’å–å¾— (?id=1 ãªã©)
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('id')) {
        myPlayerId = parseInt(urlParams.get('id'));
        document.getElementById('my-id-disp').innerText = myPlayerId;
    }

    // ===== ã‚µã‚¤ã‚³ãƒ­å›è»¢ï¼ˆç–‘ä¼¼ã‚¢ãƒ‹ãƒ¡ï¼‰åˆ¶å¾¡ =====
    let rollingTimer = null;
    const DICE_FACES = ["ãƒ•", "ã‚¯", "ãƒ­", "ãƒ†", "ãƒŠ", "ã‚¬"];

    function startRolling() {
        if (rollingTimer) return; // äºŒé‡èµ·å‹•é˜²æ­¢
        rollingTimer = setInterval(() => {
            const a = DICE_FACES[Math.floor(Math.random() * 6)];
            const b = DICE_FACES[Math.floor(Math.random() * 6)];
            const c = DICE_FACES[Math.floor(Math.random() * 6)];
            const d = DICE_FACES[Math.floor(Math.random() * 6)];
            const e = DICE_FACES[Math.floor(Math.random() * 6)];
            const f = DICE_FACES[Math.floor(Math.random() * 6)];
            renderDice(`${a}${b}${c}${d}${e}${f}`);
        }, 80);
    }


    function stopRolling(finalEyesStr) {
        if (rollingTimer) {
            clearInterval(rollingTimer);
            rollingTimer = null;
        }
        if (finalEyesStr) renderDice(finalEyesStr);
    }


    // ===== é€šä¿¡å‡¦ç† =====
    function connect() {
        ws = new WebSocket(GAME_SERVER_URL);

        ws.onopen = () => {
            log("ã‚µãƒ¼ãƒã«æ¥ç¶šã—ã¾ã—ãŸ");

            // è‡ªåˆ†ã®åå‰ã‚’å–å¾—ã—ã¦é€ä¿¡ã™ã‚‹(ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåã¨ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã®æ•´åˆæ€§ã®ãŸã‚ã®å‡¦ç½®ã€‚APã‚µãƒ¼ãƒã®SingleGame~ã‚¯ãƒ©ã‚¹ã‚’å‚è€ƒ)
            const myName = sessionStorage.getItem("userId");
            if (!myName) {
                toast("ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚Šã¾ã™ã€‚");
                setTimeout(() => location.href = "./home.html", 2000);
                return;
            }

            // clientName ã‚’ä»˜ä¸ã—ã¦ START
            send({
                phase: "START",
                clientName: myName
            });
        };

        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            enqueueMessage(msg);
        };

        ws.onclose = () => {
            log("åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ");
            document.getElementById("status-text").innerText = "åˆ‡æ–­";
            stopRolling();
            showRollUI(false);
        };
    }

    async function handleMessageAsync(msg) {
        console.log("Recv:", msg);

        if (msg.phase === "ERROR") {
            toast("ã‚¨ãƒ©ãƒ¼: " + msg.message);
            stopRolling();
            showRollUI(false);
            return;
        }

        if (msg.players) {
            lastPlayersData = msg.players;
            renderPlayers(msg.players);
        }

        switch (msg.phase) {
            case "START":
                if (myPlayerId === null && msg.playerId) {
                    myPlayerId = msg.playerId;
                    // my-id-disp ãŒç„¡ã„å ´åˆã§ã‚‚è½ã¡ãªã„ã‚ˆã†ã«
                    const el = document.getElementById("my-id-disp");
                    if (el) el.innerText = myPlayerId;
                    window.history.replaceState(null, null, "?id=" + myPlayerId);
                }
                updatePhaseDisplay("ã‚²ãƒ¼ãƒ é–‹å§‹ï¼");
                break;

            case "BET":
                stopRolling();
                showRollUI(false);

                // è‡ªåˆ†ã®çŠ¶æ…‹ã‚’æ¢ã™
                const me = lastPlayersData.find(p => p.playerId === myPlayerId);

                // è‡ªåˆ†ãŒè¦ª(dealer)ãªã‚‰UIã‚’å‡ºã•ãšã«å¾…æ©Ÿãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                if (me && me.dealer) {
                    updatePhaseDisplay("å­ãŒè³­ã‘ã‚‹ã®ã‚’å¾…ã£ã¦ã„ã¾ã™..."); // è¦ªç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    showBetUI(false); // UIã¯éš ã™
                } else {
                    updatePhaseDisplay("è³­ã‘ã‚¿ã‚¤ãƒ "); // å­ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    showBetUI(true);  // UIã‚’è¡¨ç¤º
                }
                break;

            case "ROLL":
                updatePhaseDisplay("ã‚µã‚¤ã‚³ãƒ­ã‚¿ã‚¤ãƒ : ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ " + msg.playerId + " ã®ç•ª");
                showBetUI(false);

                startRolling();                 // å…¨å“¡å›è»¢é–‹å§‹
                await sleep(WAIT_AFTER_ROLL_MS);// â˜…æœ€ä½è¡¨ç¤ºæ™‚é–“

                if (msg.playerId === myPlayerId) {
                    const btn = document.getElementById("roll-btn");
                    btn.textContent = "æ­¢ã‚ã‚‹";
                    showRollUI(true);
                    toast("ã‚ãªãŸã®ç•ªã§ã™ï¼ï¼ˆæ­¢ã‚ã‚‹ãƒœã‚¿ãƒ³ã§ç¢ºå®šï¼‰");
                } else {
                    showRollUI(false);
                }
                break;

            case "HAND":
                // â˜…è¿½åŠ : ã“ã“ã§åœæ­¢éŸ³ã‚’å†ç”Ÿï¼ˆå…¨å“¡ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§å®Ÿè¡Œã•ã‚Œã‚‹ï¼‰
                stopSound.currentTime = 0; // é€£ç¶šå†ç”Ÿç”¨ã«å·»ãæˆ»ã—
                stopSound.play().catch(e => console.log("å†ç”Ÿã‚¨ãƒ©ãƒ¼(åˆå›æ“ä½œå‰ãªã©):", e));

                stopRolling();
                showRollUI(false); // ä¸€æ—¦ãƒœã‚¿ãƒ³ã‚’éš ã™

                renderDice(msg.eyesRolled);

                // 2ç§’ã®ã‚¿ã‚¤ãƒ ãƒ©ã‚°ï¼ˆæ¼”å‡ºç”¨ï¼‰
                await sleep(2000);

                if (msg.hand && msg.hand.handStrength > 0) {
                    // --- å½¹ãŒã‚ã£ãŸå ´åˆ ---
                    toast(`Player ${msg.playerId} ã®å‡ºç›®: ${msg.eyesRolled} â†’ å½¹: ${msg.hand.handName}ï¼`);
                    await showCutInAsync(msg.hand.handName, 2600);
                } else {
                    // --- å½¹ãŒå‡ºãªã‹ã£ãŸå ´åˆï¼ˆã‚„ã‚Šç›´ã—ï¼‰ ---
                    toast(`Player ${msg.playerId} ã¯å½¹ãªã—... (ã‚„ã‚Šç›´ã— ${msg.rerollCount}å›ç›®)`);

                    // è‡ªåˆ†ã®ç•ªã§ã‚ã‚Œã°ã€å†ã³ã€Œæ­¢ã‚ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ã¦å…¥åŠ›ã‚’å¾…ã¤
                    if (msg.playerId === myPlayerId) {
                        const btn = document.getElementById("roll-btn");
                        btn.textContent = "æ­¢ã‚ã‚‹"; // ã¾ãŸã¯ã€Œã‚‚ã†ä¸€åº¦æŒ¯ã‚‹ã€
                        showRollUI(true);
                        startRolling(); // å†ã³ã‚µã‚¤ã‚³ãƒ­ã‚’å›è»¢ã•ã›ã‚‹
                        toast("å½¹ãŒå‡ºã¾ã›ã‚“ã§ã—ãŸã€‚è‡ªå‹•ã§æŒ¯ã‚ŠãªãŠã—ã¾ã™ã€‚");
                    }

                    await sleep(WAIT_HAND_MS);
                }
                break;

            case "ROUND_RESULT"://ãƒ©ã‚¦ãƒ³ãƒ‰çµæœ
                stopRolling();
                showRollUI(false);

                // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤ºã—ã¦å¾…æ©Ÿ
                await showRoundResult(msg.roundResults);
                break;


            case "RESULT":
                stopRolling();
                showRollUI(false);

                toast(msg.message);
                updatePhaseDisplay("çµæœç™ºè¡¨: " + msg.message);

                try {
                    localStorage.setItem("chinchi_last_result", JSON.stringify(msg));
                } catch (e) {}

                await sleep(WAIT_AFTER_RESULT_MS);

                location.href = "./result.html";
                break;

            case "STATE":
                // ã™ã§ã« renderPlayers ã—ã¦ã„ã‚‹ã®ã§ã“ã“ã¯ä½•ã‚‚ã—ãªãã¦OK
                break;
        }
    }

    //======ãƒ©ã‚¦ãƒ³ãƒ‰çµæœ======

    function showRoundResult(results) {
        return new Promise(resolve => {
            roundSound.currentTime = 0;
            roundSound.play().catch(e => console.log("å†ç”Ÿã‚¨ãƒ©ãƒ¼:", e));

            const overlay = document.getElementById("round-result-overlay");
            const title = document.getElementById("round-winner-text");
            const list = document.getElementById("round-result-list");
            const nextText = document.getElementById("next-dealer-text");

            list.innerHTML = "";

            // å‹è€…ï¼ˆãƒãƒŠãƒŠãŒå¢—ãˆãŸäººï¼‰ã‚’æ¢ã™
            const winners = results.filter(r => r.isWinner);
            if (winners.length > 0) {
                const names = winners.map(w => w.name).join(" & ");
                title.innerText = `${names} ã®å‹ã¡ï¼`;
                title.style.color = "#d35b31";
            } else {
                title.innerText = "å¼•ãåˆ†ã‘ / å¤‰å‹•ãªã—";
                title.style.color = "#777";
            }

            // æ¬¡ã®è¦ª
            const nextDealer = results.find(r => r.isNextDealer);
            if (nextDealer) {
                nextText.innerText = `æ¬¡ã¯ ${nextDealer.name} ãŒè¦ª(ãƒœã‚¹çŒ¿)ã§ã™`;
            }

            // å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å¢—æ¸›ã‚’è¡¨ç¤º
            results.forEach(r => {
                const row = document.createElement("div");
                row.className = "round-result-item";

                let diffStr = "";
                let diffClass = "diff-zero";
                if (r.bananaDiff > 0) {
                    diffStr = `+${r.bananaDiff}`;
                    diffClass = "diff-plus";
                } else if (r.bananaDiff < 0) {
                    diffStr = `${r.bananaDiff}`; // ãƒã‚¤ãƒŠã‚¹ã¯æ•°å€¤ã«å«ã¾ã‚Œã‚‹
                    diffClass = "diff-minus";
                } else {
                    diffStr = "Â±0";
                }

                row.innerHTML = `
                    <span>${r.name}</span>
                    <span class="${diffClass}">${diffStr}ğŸŒ</span>
                `;
                list.appendChild(row);
            });

            // è¡¨ç¤ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            overlay.style.display = "flex";
            // ã‚ãšã‹ã«é…ã‚‰ã›ã¦CSS transitionã‚’ç™ºç«
            requestAnimationFrame(() => overlay.classList.add("show"));

            // ä¸€å®šæ™‚é–“å¾Œã«éè¡¨ç¤º
            setTimeout(() => {
                overlay.classList.remove("show");
                setTimeout(() => {
                    overlay.style.display = "none";
                    resolve(); // å‡¦ç†å®Œäº†ã‚’é€šçŸ¥
                }, 500); // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆå¾…ã¡
            }, WAIT_ROUND_RESULT_MS);
        });
    }


    // ===== é€ä¿¡ =====
    function sendBet() {
        const inputEl = document.getElementById("bet-input");
        const amount = parseInt(document.getElementById("bet-input").value);

        if (!amount || amount <= 0) {
            toast("1æœ¬ä»¥ä¸Šã®ãƒãƒŠãƒŠã‚’è³­ã‘ã¦ãã ã•ã„ï¼");
            return;
        }

        // lastPlayersData ã‹ã‚‰è‡ªåˆ†ã®æœ€æ–°æƒ…å ±ã‚’å–å¾—
        const me = lastPlayersData.find(p => p.playerId === myPlayerId);

        if (me) {
            if (amount > me.ownedBananas) {
                // æ‰€æŒæ•°ã‚ªãƒ¼ãƒãƒ¼ãªã‚‰é€ä¿¡ã›ãšã€è­¦å‘Šã‚’å‡ºã—ã¦çµ‚äº†ï¼ˆUIã¯æ¶ˆã•ãªã„ï¼‰
                toast(`æ‰€æŒãƒãƒŠãƒŠãŒè¶³ã‚Šã¾ã›ã‚“ï¼`);
                inputEl.value = me.ownedBananas; // è¦ªåˆ‡ã«å…¥åŠ›å€¤ã‚’æ‰€æŒé‡‘æœ€å¤§ã«ã™ã‚‹
                return;
            }
        }

        betSound.currentTime = 0; // é€£æ‰“å¯¾ç­–ï¼ˆè³­ã‘ã‚‹ã¨ãã®SEï¼‰
        betSound.play().catch(e => console.log("å†ç”Ÿã‚¨ãƒ©ãƒ¼:", e));

        send({
            phase: "BET",
            betBananas: amount
        });
        showBetUI(false);
    }

    function sendRoll() {
        // â˜…ã€Œæ­¢ã‚ã‚‹ã€ï¼ ROLL ã‚’é€ã‚‹ï¼ˆä»•æ§˜ã©ãŠã‚Šï¼‰
        send({ phase: "ROLL" });

        // é€£æ‰“é˜²æ­¢ï¼ˆHANDãŒæ¥ãŸã‚‰éè¡¨ç¤ºã«ãªã‚‹ï¼‰
        const btn = document.getElementById("roll-btn");
        btn.disabled = true;
    }

    function send(obj) {
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify(obj));
        } else {
            toast("ã‚µãƒ¼ãƒã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“");
        }
    }

    // ===== UI =====
    function preloadYakuImages() {
        Object.values(yakuImages).forEach(src => {
            const im = new Image();
            im.src = src;
        });
    }
    preloadYakuImages();

    /**
     * ã‚«ãƒƒãƒˆã‚¤ãƒ³ã‚’è¡¨ç¤ºã—ã€è¡¨ç¤ºå®Œäº†å¾Œã« resolve ã™ã‚‹ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼ã¨åŒæœŸã•ã›ã‚‹ï¼‰
     */
    function showCutInAsync(handName, durationMs = 2600) {
        return new Promise((resolve) => {
            const overlay = document.getElementById('cutin-overlay');
            const img = document.getElementById('monkey-photo');
            const leftText = document.getElementById('cutin-text-left');
            const rightText = document.getElementById('cutin-text-right');

            leftText.innerText = handName;
            rightText.innerText = handName;

            const imgSrc = yakuImages[handName];
            ///////////////////////////////////////////////
            //éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®å·®ã—è¾¼ã¿
            ///////////////////////////////////////////////
            const soundSrc = yakuSounds[handName];

            const startShow = () => {
                if (soundSrc) {
                    //éŸ³å£°å†ç”Ÿ/////////////////////////////////////
                    const audio = new Audio(soundSrc);
                    audio.volume = 0.8; // éŸ³é‡ï¼ˆ0.0ã€œ1.0ï¼‰
                    audio.play().catch(e => console.error("éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:", e));
                }//ã“ã“ã¾ã§éŸ³å£°å†ç”Ÿ//////////////////////////////////////////////
                overlay.style.display = "flex";
                requestAnimationFrame(() => overlay.classList.add("show"));

                setTimeout(() => {
                    overlay.classList.remove("show");
                    setTimeout(() => {
                        overlay.style.display = "none";
                        resolve();
                    }, 1000);
                }, durationMs);
            };

            if (imgSrc) {
                img.style.display = "block";

                // èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«è¦‹ã›ã‚‹ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿ã§ã‚‚ onload ã¯ç™ºç«ã™ã‚‹ï¼‰
                img.onload = startShow;
                img.onerror = () => {
                    // ç”»åƒãŒèª­ã‚ãªãã¦ã‚‚ãƒ†ã‚­ã‚¹ãƒˆæ¼”å‡ºã ã‘ã¯å‡ºã™
                    img.style.display = "none";
                    startShow();
                };

                img.src = imgSrc;
            } else {
                // å¯¾å¿œç”»åƒãŒãªã„å½¹åãªã‚‰ç”»åƒã¯å‡ºã•ãšã«ãƒ†ã‚­ã‚¹ãƒˆæ¼”å‡ºã®ã¿
                img.style.display = "none";
                startShow();
            }
        });
    }



    function renderPlayers(players) {
        const wrapper = document.getElementById("players-wrapper");
        wrapper.innerHTML = "";

        players.forEach(p => {
            const isMe = (p.playerId === myPlayerId);
            const div = document.createElement("div");
            div.className = "player-card" + (isMe ? " is-me" : "") + (p.dealer ? " is-dealer" : "");

            div.innerHTML = `
                ${p.dealer ? '<div class="dealer-badge">ãƒœã‚¹ã‚¶ãƒ«</div>' : ''}
                <div class="info-row">
                    <strong>${p.name}</strong>
                    <span>ID:${p.playerId}</span>
                </div>
                <div class="info-row">
                    <span>æ‰€æŒãƒãƒŠãƒŠ: ${p.ownedBananas}ğŸŒ</span>
                </div>
                <div class="info-row" style="background:#eee; padding:2px;">
    <span>è³­ã‘ãƒãƒŠãƒŠ: ${(
                (p.currentBetBananas ?? p.betBananas ?? 0)
            )}ğŸŒ</span>
</div>

            `;
            wrapper.appendChild(div);
        });
    }

    function renderDice(eyesStr) {
        const container = document.getElementById("main-dice-area");
        container.innerHTML = "";
        if (!eyesStr) return;

        for (let char of eyesStr) {
            const d = document.createElement("div");
            d.className = "dice";
            d.innerText = char;
            container.appendChild(d);
        }
    }

    function showBetUI(show) {
        document.getElementById("bet-ui").style.display = show ? "block" : "none";
        document.getElementById("roll-btn").style.display = "none";
    }

    // â˜…ã€Œæ­¢ã‚ã‚‹ã€ãƒœã‚¿ãƒ³è¡¨ç¤ºï¼ˆROLLã® playerId ãŒè‡ªåˆ†ã®ã¨ãã ã‘ä½¿ã†ï¼‰
    function showRollUI(show) {
        const btn = document.getElementById("roll-btn");
        // ãƒ†ã‚­ã‚¹ãƒˆã¯å‘¼ã³å‡ºã—å…ƒã§åˆ¶å¾¡ã§ãã‚‹ã‚ˆã†ã«ã€ã“ã“ã§ã¯å¼·åˆ¶å¤‰æ›´ã—ãªã„
        btn.style.display = show ? "inline-block" : "none";
        btn.disabled = false; // â˜… showã®æ™‚ã«å¿…ãšæŠ¼ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹
        document.getElementById("bet-ui").style.display = "none";
    }

    function updatePhaseDisplay(text) {
        document.getElementById("instruction-text").innerText = text;
    }

    function toast(msg) {
        const el = document.getElementById("toast");
        el.innerText = msg;
        el.classList.add("show");
        setTimeout(() => el.classList.remove("show"), 3000);
    }

    function log(txt) {
        console.log("[Client]", txt);
    }

    window.forceBind = function(id) {
        myPlayerId = id;
        document.getElementById('my-id-disp').innerText = id;
        send({ phase: "START" });
    }

    function playBgm() {
        battleBgm.play().catch(e => {
            console.log("BGMè‡ªå‹•å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã‚’å¾…ã¡ã¾ã™ã€‚", e);

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç”»é¢ã®ã©ã“ã‹ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼ˆã‚¿ãƒƒãƒ—ï¼‰ã—ãŸã‚‰å†ç”Ÿé–‹å§‹
            const startOnInteract = () => {
                battleBgm.play();
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ï¼ˆ1å›ã ã‘ã§è‰¯ã„ãŸã‚ï¼‰
                document.body.removeEventListener('click', startOnInteract);
                document.body.removeEventListener('touchstart', startOnInteract);
            };

            document.body.addEventListener('click', startOnInteract);
            document.body.addEventListener('touchstart', startOnInteract);
        });
    }

    // å®Ÿè¡Œé–‹å§‹
    connect();
    playBgm();
</script>
</body>
</html>
