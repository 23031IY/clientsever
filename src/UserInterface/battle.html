<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>„ÉÅ„É≥„ÉÅ„É≠„É™„É≥ - „Éê„Éà„É´</title>
    <div id="my-id-disp" style="margin-top:6px; font-size:1.2rem; color:#8b4513;">ID:-</div>
    <style>
        @font-face { font-family: 'BananaSlip'; src: url('YDWbananaslipplus.otf') format('opentype'); }
        body {
            font-family: 'BananaSlip', sans-serif;
            background-color: #f7e7ce;
            margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 20px;
        }
        .dice-container { display: flex; gap: 15px; margin: 20px 0; min-height: 80px;}
        .dice { width: 60px; height: 60px; background: white; border: 2px solid #555; display: flex; justify-content: center; align-items: center; font-size: 2rem; border-radius: 8px;}

        .players-area { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; width: 100%; max-width: 1000px; }
        .player-card { border: 3px solid #8b4513; background: #fff; padding: 10px; width: 200px; border-radius: 10px; position: relative;}
        .player-card.is-me { border-color: #ff0000; box-shadow: 0 0 10px rgba(255,0,0,0.3); }
        .player-card.is-dealer { background-color: #fff8e1; }
        .player-card.is-turn { background-color: #e0f7fa; transform: scale(1.05); transition: 0.3s; }

        .dealer-badge { position: absolute; top: -10px; right: -10px; background: gold; border: 1px solid #000; padding: 2px 8px; font-size: 0.8rem; border-radius: 10px;}

        .info-row { display: flex; justify-content: space-between; margin-bottom: 5px; }

        .action-area { margin-top: 20px; padding: 20px; background: rgba(255,255,255,0.8); border-radius: 10px; text-align: center; min-height: 100px; display: flex; flex-direction: column; justify-content: center; align-items: center;}

        button { font-family: 'BananaSlip'; font-size: 1.2rem; padding: 10px 30px; cursor: pointer; background: #8b4513; color: white; border: none; border-radius: 5px;}
        button:disabled { background: #ccc; cursor: not-allowed; }

        .msg-box { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: 0.5s; pointer-events: none; z-index: 1001;}
        .msg-box.show { opacity: 1; top: 30px; }

        #debug-panel { position: fixed; bottom: 0; left: 0; background: #eee; padding: 5px; font-size: 0.8rem; opacity: 0.8; z-index: 900;}

        #cutin-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            opacity: 0;
            transition: opacity 0.3s;
        }
        #cutin-overlay.show { opacity: 1; }

        .cutin-content {
            display: flex;
            align-items: center;
            gap: 40px;
            transform: scale(0.8);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #cutin-overlay.show .cutin-content { transform: scale(1); }

        .monkey-img {
            width: 600px;
            height: 450px;
            border: 8px solid white;
            object-fit: cover;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.5);
        }

        .yaku-text-vertical {
            font-family: 'BananaSlip', sans-serif;
            font-size: 6rem;
            writing-mode: vertical-rl;
            text-orientation: upright;
            color: #ffcc00;
            text-shadow: 4px 4px 0px #8b4513;
            letter-spacing: 10px;
        }


        /* „É©„Ç¶„É≥„ÉâÁµêÊûú„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó */
        #round-result-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.5s;
        }
        #round-result-overlay.show { opacity: 1; }

        .round-result-box {
            background: #fff; border: 5px solid #8b4513; border-radius: 20px;
            padding: 30px; width: 500px; text-align: center;
            box-shadow: 0 0 30px rgba(255, 204, 0, 0.5);
        }
        .round-winner-title {
            font-size: 2.5rem; color: #d35b31; margin: 0 0 20px 0;
            text-shadow: 2px 2px 0px #fff;
        }
        .round-result-list {
            margin-bottom: 20px; border-top: 2px dashed #ccc; border-bottom: 2px dashed #ccc;
            padding: 10px 0;
        }
        .round-result-item {
            display: flex; justify-content: space-between; font-size: 1.5rem; margin: 8px 0;
        }
        .diff-plus { color: #e91e63; font-weight: bold; }
        .diff-minus { color: #3f51b5; }
        .diff-zero { color: #777; }
        .next-dealer-info {
            font-size: 1.2rem; color: #8b4513; font-weight: bold; background: #fff8e1;
            padding: 10px; border-radius: 10px; display: inline-block;
        }
    </style>
</head>
<body>

<div id="toast" class="msg-box"></div>

<div id="cutin-overlay">
    <div class="cutin-content">
        <div class="yaku-text-vertical" id="cutin-text-left">ÂΩπÂêç</div>
        <img src="" id="monkey-photo" class="monkey-img" alt="ÊºîÂá∫ÁîªÂÉè">
        <div class="yaku-text-vertical" id="cutin-text-right">ÂΩπÂêç</div>
    </div>
</div>

<div id="round-result-overlay" style="display:none;">
    <div class="round-result-box">
        <h2 class="round-winner-title" id="round-winner-text">Ë™∞„ÇÇÂãù„Å¶„Åæ„Åõ„Çì„Åß„Åó„Åü...</h2>
        <div id="round-result-list" class="round-result-list">
        </div>
        <div class="next-dealer-info" id="next-dealer-text">Ê¨°„ÅØ „Äá„Äá „ÅåË¶™„Åß„Åô</div>
    </div>
</div>

<div style="text-align: center;">
    <h1 style="margin: 0; color: #8b4513;">„Éê„Éà„É´ÁîªÈù¢</h1>
    <div id="status-text">Êé•Á∂öÂæÖÊ©ü‰∏≠...</div>
</div>

<div class="dice-container" id="main-dice-area"></div>

<div class="action-area" id="action-panel">
    <div id="instruction-text">„Ç≤„Éº„É†ÈñãÂßã„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...</div>
    <div style="margin-top: 10px;">
        <div id="bet-ui" style="display:none;">
            <input type="number" id="bet-input" value="100" style="font-size:1.2rem; width:80px;">
            <button onclick="sendBet()">Ë≥≠„Åë„Çã</button>
        </div>
        <button id="roll-btn" style="display:none;" onclick="sendRoll()">Ê≠¢„ÇÅ„Çã</button>
    </div>
</div>

<div class="players-area" id="players-wrapper"></div>
<script>
    /*
    * „ÇÑ„Çä„Åü„ÅÑ„Åì„Å®(1/15)
    * ÂΩπÁ¢∫ÂÆö->ÁîªÂÉèË°®Á§∫„Åæ„Åß„ÅÆ„Çø„Ç§„É†„É©„Ç∞Ë®≠ÂÆö
    * „Éá„Éê„ÉÉ„Ç∞Áî®„Éú„Çø„É≥„ÅÆÈô§Âéª
    * ÂäπÊûúÈü≥Ë®≠ÂÆö
    * */



    const GAME_SERVER_URL = "ws://localhost:8082/GameServer/ws";

    let ws = null;
    let myPlayerId = null;
    let lastPlayersData = [];//„Éó„É¨„Ç§„É§„Éº„É™„Çπ„Éà‰øùÂ≠òÁî®„Å´„Å§„ÅÑ„Åã„Åó„Åü

    // ÂΩπÂêç„Å®ÁîªÂÉè„Éï„Ç°„Ç§„É´„ÅÆ„Å≤„ÇÇ„Å•„Åë
    const yakuImages = {
        "„Éï„ÇØ„É≠„ÉÜ„Éä„Ç¨„Ç∂„É´": "./fukurotenaga.jpg",
        "„ÉÜ„Éä„Ç¨„Ç∂„É´": "./tenaga.jpg",
        "„Éä„Ç¨„Ç∂„É´": "./naga.jpg",
        "„ÇØ„É≠„Ç∂„É´": "./kuro.jpg",
        "„Éä„Ç¨„Éª„ÇØ„É≠„Ç∂„É´": "./naga.jpg"
    };

    // ÂΩπ„Å´ÂØæÂøú„Åó„ÅüÂäπÊûúÈü≥„ÅÆË®≠ÂÆö
    const yakuSounds = {
        "„Éï„ÇØ„É≠„ÉÜ„Éä„Ç¨„Ç∂„É´": "./sounds/fukuro_cry.mp3", // „Éï„Ç°„Ç§„É´„Éë„Çπ„ÅØÈÅ©ÂÆúÂ§âÊõ¥„Åó„Å¶„Åè„Å†„Åï„ÅÑ
        "„ÉÜ„Éä„Ç¨„Ç∂„É´": "./sounds/naga_cry.mp3",
        "„Éä„Ç¨„Ç∂„É´": "./sounds/naga_cry.mp3",
        "„ÇØ„É≠„Ç∂„É´": "./sounds/kuro_cry.mp3",
        "„Éä„Ç¨„Éª„ÇØ„É≠„Ç∂„É´": ["./sounds/naga_cry.mp3", "./sounds/kuro_cry.mp3"]
    };
    const stopSound = new Audio("./sounds/dice_stop.mp3");//„Çµ„Ç§„Ç≥„É≠SE
    stopSound.volume = 0.8;

    const betSound = new Audio("./sounds/monkey_cry.mp3");//Ë≥≠„Åë„Çã„Å®„Åç„ÅÆSE
    betSound.volume = 1.0;



    // ===== Âèó‰ø°„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÁõ¥ÂàóÂá¶ÁêÜ„Åô„Çã„Ç≠„É•„Éº =====
    const messageQueue = [];
    let processing = false;

    const WAIT_AFTER_ROLL_MS = 300;  // ROLLË°®Á§∫„ÅÆÊúÄ‰ΩéÊôÇÈñì
    const WAIT_HAND_MS = 1500;       // HANDË°®Á§∫„ÅÆÊúÄ‰ΩéÊôÇÈñìÔºàÂΩπ„Ç´„ÉÉ„Éà„Ç§„É≥Á≠â„ÅÆ„Åü„ÇÅÔºâ
    const WAIT_AFTER_RESULT_MS = 2000;
    const WAIT_ROUND_RESULT_MS = 4000;//„É©„Ç¶„É≥„ÉâÁµêÊûú„ÅÆË°®Á§∫ÊôÇÈñì

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function enqueueMessage(msg) {
        messageQueue.push(msg);
        if (!processing) {
            processing = true;
            while (messageQueue.length > 0) {
                const next = messageQueue.shift();
                await handleMessageAsync(next);
            }
            processing = false;
        }
    }


    // URL„Éë„É©„É°„Éº„Çø„Åã„ÇâID„ÇíÂèñÂæó (?id=1 „Å™„Å©)
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('id')) {
        myPlayerId = parseInt(urlParams.get('id'));
        document.getElementById('my-id-disp').innerText = myPlayerId;
    }

    // ===== „Çµ„Ç§„Ç≥„É≠ÂõûËª¢ÔºàÁñë‰ºº„Ç¢„Éã„É°ÔºâÂà∂Âæ° =====
    let rollingTimer = null;
    const DICE_FACES = ["„Éï", "„ÇØ", "„É≠", "„ÉÜ", "„Éä", "„Ç¨"];

    function startRolling() {
        if (rollingTimer) return; // ‰∫åÈáçËµ∑ÂãïÈò≤Ê≠¢
        rollingTimer = setInterval(() => {
            const a = DICE_FACES[Math.floor(Math.random() * 6)];
            const b = DICE_FACES[Math.floor(Math.random() * 6)];
            const c = DICE_FACES[Math.floor(Math.random() * 6)];
            const d = DICE_FACES[Math.floor(Math.random() * 6)];
            const e = DICE_FACES[Math.floor(Math.random() * 6)];
            const f = DICE_FACES[Math.floor(Math.random() * 6)];
            renderDice(`${a}${b}${c}${d}${e}${f}`);
        }, 80);
    }


    function stopRolling(finalEyesStr) {
        if (rollingTimer) {
            clearInterval(rollingTimer);
            rollingTimer = null;
        }
        if (finalEyesStr) renderDice(finalEyesStr);
    }


    // ===== ÈÄö‰ø°Âá¶ÁêÜ =====
    function connect() {
        ws = new WebSocket(GAME_SERVER_URL);

        ws.onopen = () => {
            log("„Çµ„Éº„Éê„Å´Êé•Á∂ö„Åó„Åæ„Åó„Åü");

            // Ëá™ÂàÜ„ÅÆÂêçÂâç„ÇíÂèñÂæó„Åó„Å¶ÈÄÅ‰ø°„Åô„Çã(„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂêç„Å®„Éó„É¨„Ç§„É§„ÉºÂêç„ÅÆÊï¥ÂêàÊÄß„ÅÆ„Åü„ÇÅ„ÅÆÂá¶ÁΩÆ„ÄÇAP„Çµ„Éº„Éê„ÅÆSingleGame~„ÇØ„É©„Çπ„ÇíÂèÇËÄÉ)
            const myName = sessionStorage.getItem("userId");
            if (!myName) {
                toast("„É≠„Ç∞„Ç§„É≥ÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ„Éõ„Éº„É†„Å∏Êàª„Çä„Åæ„Åô„ÄÇ");
                setTimeout(() => location.href = "./home.html", 2000);
                return;
            }

            // clientName „Çí‰ªò‰∏é„Åó„Å¶ START
            send({
                phase: "START",
                clientName: myName
            });
        };

        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            enqueueMessage(msg);
        };

        ws.onclose = () => {
            log("ÂàáÊñ≠„Åï„Çå„Åæ„Åó„Åü");
            document.getElementById("status-text").innerText = "ÂàáÊñ≠";
            stopRolling();
            showRollUI(false);
        };
    }

    async function handleMessageAsync(msg) {
        console.log("Recv:", msg);

        if (msg.phase === "ERROR") {
            toast("„Ç®„É©„Éº: " + msg.message);
            stopRolling();
            showRollUI(false);
            return;
        }

        if (msg.players) {
            lastPlayersData = msg.players;
            renderPlayers(msg.players);
        }

        switch (msg.phase) {
            case "START":
                if (myPlayerId === null && msg.playerId) {
                    myPlayerId = msg.playerId;
                    // my-id-disp „ÅåÁÑ°„ÅÑÂ†¥Âêà„Åß„ÇÇËêΩ„Å°„Å™„ÅÑ„Çà„ÅÜ„Å´
                    const el = document.getElementById("my-id-disp");
                    if (el) el.innerText = myPlayerId;
                    window.history.replaceState(null, null, "?id=" + myPlayerId);
                }
                updatePhaseDisplay("„Ç≤„Éº„É†ÈñãÂßãÔºÅ");
                break;

            case "BET":
                stopRolling();
                showRollUI(false);

                // Ëá™ÂàÜ„ÅÆÁä∂ÊÖã„ÇíÊé¢„Åô
                const me = lastPlayersData.find(p => p.playerId === myPlayerId);

                // Ëá™ÂàÜ„ÅåË¶™(dealer)„Å™„ÇâUI„ÇíÂá∫„Åï„Åö„Å´ÂæÖÊ©ü„É°„ÉÉ„Çª„Éº„Ç∏
                if (me && me.dealer) {
                    updatePhaseDisplay("Â≠ê„ÅåË≥≠„Åë„Çã„ÅÆ„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô..."); // Ë¶™Áî®„É°„ÉÉ„Çª„Éº„Ç∏
                    showBetUI(false); // UI„ÅØÈö†„Åô
                } else {
                    updatePhaseDisplay("Ë≥≠„Åë„Çø„Ç§„É†"); // Â≠êÁî®„É°„ÉÉ„Çª„Éº„Ç∏
                    showBetUI(true);  // UI„ÇíË°®Á§∫
                }
                break;

            case "ROLL":
                updatePhaseDisplay("„Çµ„Ç§„Ç≥„É≠„Çø„Ç§„É†: „Éó„É¨„Ç§„É§„Éº " + msg.playerId + " „ÅÆÁï™");
                showBetUI(false);

                startRolling();                 // ÂÖ®Âì°ÂõûËª¢ÈñãÂßã
                await sleep(WAIT_AFTER_ROLL_MS);// ‚òÖÊúÄ‰ΩéË°®Á§∫ÊôÇÈñì

                if (msg.playerId === myPlayerId) {
                    const btn = document.getElementById("roll-btn");
                    btn.textContent = "Ê≠¢„ÇÅ„Çã";
                    showRollUI(true);
                    toast("„ÅÇ„Å™„Åü„ÅÆÁï™„Åß„ÅôÔºÅÔºàÊ≠¢„ÇÅ„Çã„Éú„Çø„É≥„ÅßÁ¢∫ÂÆöÔºâ");
                } else {
                    showRollUI(false);
                }
                break;

            case "HAND":
                // ‚òÖËøΩÂä†: „Åì„Åì„ÅßÂÅúÊ≠¢Èü≥„ÇíÂÜçÁîüÔºàÂÖ®Âì°„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅßÂÆüË°å„Åï„Çå„ÇãÔºâ
                stopSound.currentTime = 0; // ÈÄ£Á∂öÂÜçÁîüÁî®„Å´Â∑ª„ÅçÊàª„Åó
                stopSound.play().catch(e => console.log("ÂÜçÁîü„Ç®„É©„Éº(ÂàùÂõûÊìç‰ΩúÂâç„Å™„Å©):", e));

                stopRolling();
                showRollUI(false); // ‰∏ÄÊó¶„Éú„Çø„É≥„ÇíÈö†„Åô

                renderDice(msg.eyesRolled);

                // 2Áßí„ÅÆ„Çø„Ç§„É†„É©„Ç∞ÔºàÊºîÂá∫Áî®Ôºâ
                await sleep(2000);

                if (msg.hand && msg.hand.handStrength > 0) {
                    // --- ÂΩπ„Åå„ÅÇ„Å£„ÅüÂ†¥Âêà ---
                    toast(`Player ${msg.playerId} „ÅÆÂá∫ÁõÆ: ${msg.eyesRolled} ‚Üí ÂΩπ: ${msg.hand.handName}ÔºÅ`);
                    await showCutInAsync(msg.hand.handName, 2600);
                } else {
                    // --- ÂΩπ„ÅåÂá∫„Å™„Åã„Å£„ÅüÂ†¥ÂêàÔºà„ÇÑ„ÇäÁõ¥„ÅóÔºâ ---
                    toast(`Player ${msg.playerId} „ÅØÂΩπ„Å™„Åó... („ÇÑ„ÇäÁõ¥„Åó ${msg.rerollCount}ÂõûÁõÆ)`);

                    // Ëá™ÂàÜ„ÅÆÁï™„Åß„ÅÇ„Çå„Å∞„ÄÅÂÜç„Å≥„ÄåÊ≠¢„ÇÅ„Çã„Äç„Éú„Çø„É≥„ÇíË°®Á§∫„Åó„Å¶ÂÖ•Âäõ„ÇíÂæÖ„Å§
                    if (msg.playerId === myPlayerId) {
                        const btn = document.getElementById("roll-btn");
                        btn.textContent = "Ê≠¢„ÇÅ„Çã"; // „Åæ„Åü„ÅØ„Äå„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåØ„Çã„Äç
                        showRollUI(true);
                        startRolling(); // ÂÜç„Å≥„Çµ„Ç§„Ç≥„É≠„ÇíÂõûËª¢„Åï„Åõ„Çã
                        toast("ÂΩπ„ÅåÂá∫„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇËá™Âãï„ÅßÊåØ„Çä„Å™„Åä„Åó„Åæ„Åô„ÄÇ");
                    }

                    await sleep(WAIT_HAND_MS);
                }
                break;

            case "ROUND_RESULT"://„É©„Ç¶„É≥„ÉâÁµêÊûú
                stopRolling();
                showRollUI(false);

                // „Ç™„Éº„Éê„Éº„É¨„Ç§„ÇíË°®Á§∫„Åó„Å¶ÂæÖÊ©ü
                await showRoundResult(msg.roundResults);
                break;


            case "RESULT":
                stopRolling();
                showRollUI(false);

                toast(msg.message);
                updatePhaseDisplay("ÁµêÊûúÁô∫Ë°®: " + msg.message);

                try {
                    localStorage.setItem("chinchi_last_result", JSON.stringify(msg));
                } catch (e) {}

                await sleep(WAIT_AFTER_RESULT_MS);

                location.href = "./result.html";
                break;

            case "STATE":
                // „Åô„Åß„Å´ renderPlayers „Åó„Å¶„ÅÑ„Çã„ÅÆ„Åß„Åì„Åì„ÅØ‰Ωï„ÇÇ„Åó„Å™„Åè„Å¶OK
                break;
        }
    }

    //======„É©„Ç¶„É≥„ÉâÁµêÊûú======

    function showRoundResult(results) {
        return new Promise(resolve => {
            const overlay = document.getElementById("round-result-overlay");
            const title = document.getElementById("round-winner-text");
            const list = document.getElementById("round-result-list");
            const nextText = document.getElementById("next-dealer-text");

            list.innerHTML = "";

            // ÂãùËÄÖÔºà„Éê„Éä„Éä„ÅåÂ¢ó„Åà„Åü‰∫∫Ôºâ„ÇíÊé¢„Åô
            const winners = results.filter(r => r.isWinner);
            if (winners.length > 0) {
                const names = winners.map(w => w.name).join(" & ");
                title.innerText = `${names} „ÅÆÂãù„Å°ÔºÅ`;
                title.style.color = "#d35b31";
            } else {
                title.innerText = "Âºï„ÅçÂàÜ„Åë / Â§âÂãï„Å™„Åó";
                title.style.color = "#777";
            }

            // Ê¨°„ÅÆË¶™
            const nextDealer = results.find(r => r.isNextDealer);
            if (nextDealer) {
                nextText.innerText = `Ê¨°„ÅØ ${nextDealer.name} „ÅåË¶™(„Éú„ÇπÁåø)„Åß„Åô`;
            }

            // ÂêÑ„Éó„É¨„Ç§„É§„Éº„ÅÆÂ¢óÊ∏õ„ÇíË°®Á§∫
            results.forEach(r => {
                const row = document.createElement("div");
                row.className = "round-result-item";

                let diffStr = "";
                let diffClass = "diff-zero";
                if (r.bananaDiff > 0) {
                    diffStr = `+${r.bananaDiff}`;
                    diffClass = "diff-plus";
                } else if (r.bananaDiff < 0) {
                    diffStr = `${r.bananaDiff}`; // „Éû„Ç§„Éä„Çπ„ÅØÊï∞ÂÄ§„Å´Âê´„Åæ„Çå„Çã
                    diffClass = "diff-minus";
                } else {
                    diffStr = "¬±0";
                }

                row.innerHTML = `
                    <span>${r.name}</span>
                    <span class="${diffClass}">${diffStr}üçå</span>
                `;
                list.appendChild(row);
            });

            // Ë°®Á§∫„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
            overlay.style.display = "flex";
            // „Çè„Åö„Åã„Å´ÈÅÖ„Çâ„Åõ„Å¶CSS transition„ÇíÁô∫ÁÅ´
            requestAnimationFrame(() => overlay.classList.add("show"));

            // ‰∏ÄÂÆöÊôÇÈñìÂæå„Å´ÈùûË°®Á§∫
            setTimeout(() => {
                overlay.classList.remove("show");
                setTimeout(() => {
                    overlay.style.display = "none";
                    resolve(); // Âá¶ÁêÜÂÆå‰∫Ü„ÇíÈÄöÁü•
                }, 500); // „Éï„Çß„Éº„Éâ„Ç¢„Ç¶„ÉàÂæÖ„Å°
            }, WAIT_ROUND_RESULT_MS);
        });
    }


    // ===== ÈÄÅ‰ø° =====
    function sendBet() {
        const amount = parseInt(document.getElementById("bet-input").value);
        if (!amount || amount <= 0) return;

        betSound.currentTime = 0; // ÈÄ£ÊâìÂØæÁ≠ñÔºàË≥≠„Åë„Çã„Å®„Åç„ÅÆSEÔºâ
        betSound.play().catch(e => console.log("ÂÜçÁîü„Ç®„É©„Éº:", e));

        send({
            phase: "BET",
            betBananas: amount
        });
        showBetUI(false);
    }

    function sendRoll() {
        // ‚òÖ„ÄåÊ≠¢„ÇÅ„Çã„ÄçÔºù ROLL „ÇíÈÄÅ„ÇãÔºà‰ªïÊßò„Å©„Åä„ÇäÔºâ
        send({ phase: "ROLL" });

        // ÈÄ£ÊâìÈò≤Ê≠¢ÔºàHAND„ÅåÊù•„Åü„ÇâÈùûË°®Á§∫„Å´„Å™„ÇãÔºâ
        const btn = document.getElementById("roll-btn");
        btn.disabled = true;
    }

    function send(obj) {
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify(obj));
        } else {
            toast("„Çµ„Éº„Éê„Å´Êé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì");
        }
    }

    // ===== UI =====
    function preloadYakuImages() {
        Object.values(yakuImages).forEach(src => {
            const im = new Image();
            im.src = src;
        });
    }
    preloadYakuImages();

    /**
     * „Ç´„ÉÉ„Éà„Ç§„É≥„ÇíË°®Á§∫„Åó„ÄÅË°®Á§∫ÂÆå‰∫ÜÂæå„Å´ resolve „Åô„ÇãÔºà„É°„ÉÉ„Çª„Éº„Ç∏„Ç≠„É•„Éº„Å®ÂêåÊúü„Åï„Åõ„ÇãÔºâ
     */
    function showCutInAsync(handName, durationMs = 2600) {
        return new Promise((resolve) => {
            const overlay = document.getElementById('cutin-overlay');
            const img = document.getElementById('monkey-photo');
            const leftText = document.getElementById('cutin-text-left');
            const rightText = document.getElementById('cutin-text-right');

            leftText.innerText = handName;
            rightText.innerText = handName;

            const imgSrc = yakuImages[handName];
            ///////////////////////////////////////////////
            //Èü≥Â£∞„Éï„Ç°„Ç§„É´„ÅÆÂ∑Æ„ÅóËæº„Åø
            ///////////////////////////////////////////////
            const soundSrc = yakuSounds[handName];

            const startShow = () => {
                if (soundSrc) {
                    //Èü≥Â£∞ÂÜçÁîü/////////////////////////////////////
                    const audio = new Audio(soundSrc);
                    audio.volume = 0.5; // Èü≥ÈáèÔºà0.0„Äú1.0Ôºâ
                    audio.play().catch(e => console.error("Èü≥Â£∞ÂÜçÁîü„Ç®„É©„Éº:", e));
                }//„Åì„Åì„Åæ„ÅßÈü≥Â£∞ÂÜçÁîü//////////////////////////////////////////////
                overlay.style.display = "flex";
                requestAnimationFrame(() => overlay.classList.add("show"));

                setTimeout(() => {
                    overlay.classList.remove("show");
                    setTimeout(() => {
                        overlay.style.display = "none";
                        resolve();
                    }, 300);
                }, durationMs);
            };

            if (imgSrc) {
                img.style.display = "block";

                // Ë™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂæå„Å´Ë¶ã„Åõ„ÇãÔºà„Ç≠„É£„ÉÉ„Ç∑„É•Ê∏à„Åø„Åß„ÇÇ onload „ÅØÁô∫ÁÅ´„Åô„ÇãÔºâ
                img.onload = startShow;
                img.onerror = () => {
                    // ÁîªÂÉè„ÅåË™≠„ÇÅ„Å™„Åè„Å¶„ÇÇ„ÉÜ„Ç≠„Çπ„ÉàÊºîÂá∫„Å†„Åë„ÅØÂá∫„Åô
                    img.style.display = "none";
                    startShow();
                };

                img.src = imgSrc;
            } else {
                // ÂØæÂøúÁîªÂÉè„Åå„Å™„ÅÑÂΩπÂêç„Å™„ÇâÁîªÂÉè„ÅØÂá∫„Åï„Åö„Å´„ÉÜ„Ç≠„Çπ„ÉàÊºîÂá∫„ÅÆ„Åø
                img.style.display = "none";
                startShow();
            }
        });
    }



    function renderPlayers(players) {
        const wrapper = document.getElementById("players-wrapper");
        wrapper.innerHTML = "";

        players.forEach(p => {
            const isMe = (p.playerId === myPlayerId);
            const div = document.createElement("div");
            div.className = "player-card" + (isMe ? " is-me" : "") + (p.dealer ? " is-dealer" : "");

            div.innerHTML = `
                ${p.dealer ? '<div class="dealer-badge">„Éú„ÇπÁåø</div>' : ''}
                <div class="info-row">
                    <strong>${p.name}</strong>
                    <span>ID:${p.playerId}</span>
                </div>
                <div class="info-row">
                    <span>ÊâÄÊåÅ: ${p.ownedBananas}üçå</span>
                </div>
                <div class="info-row" style="background:#eee; padding:2px;">
    <span>Ë≥≠„Åë: ${(
                (p.currentBetBananas ?? p.betBananas ?? 0)
            )}üçå</span>
</div>

            `;
            wrapper.appendChild(div);
        });
    }

    function renderDice(eyesStr) {
        const container = document.getElementById("main-dice-area");
        container.innerHTML = "";
        if (!eyesStr) return;

        for (let char of eyesStr) {
            const d = document.createElement("div");
            d.className = "dice";
            d.innerText = char;
            container.appendChild(d);
        }
    }

    function showBetUI(show) {
        document.getElementById("bet-ui").style.display = show ? "block" : "none";
        document.getElementById("roll-btn").style.display = "none";
    }

    // ‚òÖ„ÄåÊ≠¢„ÇÅ„Çã„Äç„Éú„Çø„É≥Ë°®Á§∫ÔºàROLL„ÅÆ playerId „ÅåËá™ÂàÜ„ÅÆ„Å®„Åç„Å†„Åë‰Ωø„ÅÜÔºâ
    function showRollUI(show) {
        const btn = document.getElementById("roll-btn");
        // „ÉÜ„Ç≠„Çπ„Éà„ÅØÂëº„Å≥Âá∫„ÅóÂÖÉ„ÅßÂà∂Âæ°„Åß„Åç„Çã„Çà„ÅÜ„Å´„ÄÅ„Åì„Åì„Åß„ÅØÂº∑Âà∂Â§âÊõ¥„Åó„Å™„ÅÑ
        btn.style.display = show ? "inline-block" : "none";
        btn.disabled = false; // ‚òÖ show„ÅÆÊôÇ„Å´ÂøÖ„ÅöÊäº„Åõ„Çã„Çà„ÅÜ„Å´„Åô„Çã
        document.getElementById("bet-ui").style.display = "none";
    }

    function updatePhaseDisplay(text) {
        document.getElementById("instruction-text").innerText = text;
    }

    function toast(msg) {
        const el = document.getElementById("toast");
        el.innerText = msg;
        el.classList.add("show");
        setTimeout(() => el.classList.remove("show"), 3000);
    }

    function log(txt) {
        console.log("[Client]", txt);
    }

    window.forceBind = function(id) {
        myPlayerId = id;
        document.getElementById('my-id-disp').innerText = id;
        send({ phase: "START" });
    }

    connect();
</script>
</body>
</html>
