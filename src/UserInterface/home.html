<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>チンチロリン - ホーム</title>
    <style>
        @font-face {
            font-family: 'BananaSlip';
            src: url('YDWbananaslipplus.otf') format('opentype');
        }

        body {
            font-family: 'BananaSlip', sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f7e7ce;
            margin: 0;
        }

        .game-title {
            font-size: 4rem;
            text-align: center;
            color: #ffcc00;
            text-shadow: 4px 4px 0px #8b4513, -1px -1px 0px #8b4513, 1px -1px 0px #8b4513, -1px 1px 0px #8b4513, 1px 1px 0px #8b4513;
            margin-bottom: 2rem;
            letter-spacing: 5px;
        }

        button {
            font-family: 'BananaSlip', sans-serif;
            width: 50%;
            padding: 1rem;
            background-color: #8b4513;
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            margin-top: 1rem;
            font-size: 1.3rem;
            transition: all 0.2s;
            box-shadow: 0 4px 0px #5d2e0d;
        }
        button:hover { background-color: #a0522d; transform: translateY(-2px); box-shadow: 0 6px 0px #5d2e0d; }
        button:active { transform: translateY(2px); box-shadow: none; }

        .user-panel {
            position: fixed;
            right: 20px;
            bottom: 20px;

            display: flex;
            align-items: center;
            gap: 12px;

            background-color: #deb887;
            border: 4px solid #8b4513;
            padding: 10px 16px;
            border-radius: 12px;

            box-shadow: 4px 4px 0px #5d2e0d;
            font-size: 1rem;
        }

        .logout-btn {
            width: auto;
            padding: 0.4rem 0.8rem;
            font-size: 1rem;
            margin-top: 0;
        }

        .status {
            margin-top: 1rem;
            color: #8b4513;
            font-size: 1.1rem;
            display: none;
        }
    </style>
</head>

<body>
<h1 class="game-title">チンチロリン</h1>

<!-- ★ onclick は関数呼び出しにする必要があるので matching() -->
<button onclick="matching()">群れに合流する</button>

<div id="status" class="status"></div>

<div class="user-panel">
    <span id="username">ユーザー名</span>
    <button class="logout-btn" onclick="logout()">森に帰る</button>
</div>

<script type="module">
    import { connect, send } from "./app.js";

    //////////////    SE     //////////////////////
    const matchSound = new Audio("./sounds/footsteps.mp3");//マッチング開始時のSE
    matchSound.volume = 0.5;

    //////////////////////////////////////////////////////

    /* ===========================
       HomeScreen 相当（本番）
    =========================== */
    const HomeScreen = {
        setStatus(msg) {
            const el = document.getElementById("status");
            el.textContent = msg;
            el.style.display = "block";
        },

        showUsername() {
            const name = sessionStorage.getItem("userId");
            document.getElementById("username").textContent = name ?? "ユーザー名";
        },

        onMatchButtonPressed() {
            const id = sessionStorage.getItem("userId");
            if (!id) {
                alert("ログイン情報がありません。ログイン画面に戻ります。");
                location.href = "./login.html";
                return;
            }

            matchSound.currentTime = 0;//マッチング開始時のSE鳴らす
            matchSound.play().catch(e => console.log("再生エラー:", e));


            // マッチング要求（サーバ仕様に合わせる）
            send({ type: "MATCHING", id: id });
            this.setStatus("マッチング中...");
        },

        onLogoutButtonPressed() {
            // IDも一緒に送ることで、サーバが待機リストから削除できるようにする
            const id = sessionStorage.getItem("userId");
            send({ type: "LOGOUT", id: id });
            this.setStatus("ログアウト中...");
        }
    };

    HomeScreen.showUsername();

    /* ===========================
       WebSocket 受信 → 分岐処理
    =========================== */
    connect((message) => {
        let json;
        try {
            json = JSON.parse(message);
        } catch (e) {
            console.log("invalid json", message);
            return;
        }

        const type = json.type;

        // マッチング結果
        if (type === "MATCH_STATUS") {
            // メッセージ内容で判定する
            const msg = json.message || "";

            if (msg === "MATCHED") {
                // 4人揃った！
                HomeScreen.setStatus("マッチング成立！バトル画面へ移動します...");
                setTimeout(() => {
                    location.href = "./battle.html";
                }, 1000); // 少し余韻を持たせる

            } else if (msg.startsWith("WAITING")) {
                // 待機中（まだ遷移しない）
                HomeScreen.setStatus("マッチング待機中... " + msg); // "WAITING(1)" などが表示される

            } else if (msg === "TIMEOUT_DISMISSED") {
                // タイムアウト解散
                HomeScreen.setStatus("マッチングが成立しませんでした（タイムアウト）");

            } else {
                // その他のエラー
                HomeScreen.setStatus("ステータス: " + msg);
            }
            return;
        }

        // ログアウト結果
        if (type === "LOGOUT_SUCCESS") {
            sessionStorage.clear();
            location.href = "./login.html";
            return;
        }

        if (type === "LOGOUT_FAILURE") {
            HomeScreen.setStatus("ログアウト失敗");
            return;
        }
    });

    /* ===========================
       HTMLから呼ぶ関数
    =========================== */
    window.matching = function () {
        HomeScreen.onMatchButtonPressed();
    };

    window.logout = function () {
        HomeScreen.onLogoutButtonPressed();
    };
</script>

</body>
</html>
